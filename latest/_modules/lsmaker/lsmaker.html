

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>lsmaker.lsmaker &mdash; linesink-maker 0.1.2.post6.dev0+gb9bd30b documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> linesink-maker
          

          
          </a>

          
            
            
              <div class="version">
                0.1.2.post6.dev0+gb9bd30b
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../philosophy.html">Philosophy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Examples</a></li>
</ul>
<p class="caption"><span class="caption-text">Usage</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Input requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html#creating-the-yaml-input-file-for-linesink-maker">Creating the YAML Input file for Linesink-maker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html#running-linesink-maker">Running Linesink-maker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html#diagnosing-errors">Diagnosing errors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html#importing-the-linesink-string-file-into-gflow">Importing the linesink string file into GFLOW</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html#viewing-the-linesinkdata-in-a-gis">Viewing the LinesinkData in a GIS</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html"> Code Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../config-file-defaults.html"> Configuration defaults</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release-history.html"> Release History</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing to linesink-maker</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">linesink-maker</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>lsmaker.lsmaker</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for lsmaker.lsmaker</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="k">as</span> <span class="nn">ET</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">fiona</span>
<span class="kn">from</span> <span class="nn">fiona.crs</span> <span class="kn">import</span> <span class="n">to_string</span><span class="p">,</span> <span class="n">from_string</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">Polygon</span><span class="p">,</span> <span class="n">LineString</span><span class="p">,</span> <span class="n">Point</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">mapping</span>
<span class="kn">from</span> <span class="nn">shapely.ops</span> <span class="kn">import</span> <span class="n">unary_union</span><span class="p">,</span> <span class="n">transform</span>
<span class="kn">import</span> <span class="nn">pyproj</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">gisutils</span>
<span class="kn">import</span> <span class="nn">lsmaker</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="kn">from</span> <span class="nn">lsmaker.diagnostics</span> <span class="kn">import</span> <span class="n">Diagnostics</span>


<span class="c1"># ## Functions #############################</span>
<div class="viewcode-block" id="add_projection"><a class="viewcode-back" href="../../api/index.html#lsmaker.lsmaker.add_projection">[docs]</a><span class="k">def</span> <span class="nf">add_projection</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">point</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add vertex to line at point,</span>
<span class="sd">    if the closest point on the line isn&#39;t an end.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    line : LineString</span>
<span class="sd">    point : Point</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    newline : LineString</span>
<span class="sd">        Line with point added, or original line, if point coincides with end.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">line</span>
    <span class="n">mp</span> <span class="o">=</span> <span class="n">point</span>
    <span class="n">distance</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">distance</span> <span class="o">&lt;=</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">distance</span> <span class="o">&gt;=</span> <span class="n">line</span><span class="o">.</span><span class="n">length</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">line</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">coords</span><span class="p">):</span>
        <span class="n">pd</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">Point</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">pd</span> <span class="o">==</span> <span class="n">distance</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">line</span>
        <span class="k">elif</span> <span class="n">pd</span> <span class="o">&gt;</span> <span class="n">distance</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">LineString</span><span class="p">(</span><span class="n">coords</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="p">[(</span><span class="n">mp</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">mp</span><span class="o">.</span><span class="n">y</span><span class="p">)]</span> <span class="o">+</span> <span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">:])</span></div>


<div class="viewcode-block" id="add_vertices_at_testpoints"><a class="viewcode-back" href="../../api/index.html#lsmaker.lsmaker.add_vertices_at_testpoints">[docs]</a><span class="k">def</span> <span class="nf">add_vertices_at_testpoints</span><span class="p">(</span><span class="n">lssdf</span><span class="p">,</span> <span class="n">tpgeoms</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mi">200</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add vertices to LinesinkData at locations of testpoints</span>
<span class="sd">    (so that modeled flow observations are correct)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lssdf : DataFrame</span>
<span class="sd">        DataFrame of linesink strings. Must contain &#39;geometry&#39; column</span>
<span class="sd">        of shapely LineStrings defining geometries of linesink strings,</span>
<span class="sd">        in same coordinate system as testpoints.</span>

<span class="sd">    tpgeoms : list</span>
<span class="sd">        List of testpoint geometries.</span>

<span class="sd">    tol : float</span>
<span class="sd">        Tolerance, in coordinate system units, for considering lines</span>
<span class="sd">        near the testpoints.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    geoms : list of geometries</span>
<span class="sd">        New geometry column with added vertices.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">lssdf</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">mp</span> <span class="ow">in</span> <span class="n">tpgeoms</span><span class="p">:</span>

        <span class="c1"># find all lines within tolerance</span>
        <span class="n">nearby</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">l</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">mp</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">tol</span><span class="p">))</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">geometry</span><span class="p">])</span>
        <span class="n">ldf</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">nearby</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># choose closest if two or more nearby lines</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ldf</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ldf</span><span class="p">[</span><span class="s1">&#39;dist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">mp</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">ll</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">ll</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">mp</span><span class="p">)))</span>
                           <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">ldf</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
            <span class="n">ldf</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;dist&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># if at least one line is nearby</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ldf</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">ldf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">ldf</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">newline</span> <span class="o">=</span> <span class="n">add_projection</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">mp</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">newline</span>
            <span class="c1">#df.set_value(ind, &#39;geometry&#39;, newline)</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span></div>


<div class="viewcode-block" id="get_elevations_from_epqs"><a class="viewcode-back" href="../../api/index.html#lsmaker.lsmaker.get_elevations_from_epqs">[docs]</a><span class="k">def</span> <span class="nf">get_elevations_from_epqs</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;feet&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;From list of shapely points in lat, lon, returns list of elevation values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;querying National Map Elevation Point Query Service...&#39;</span><span class="p">)</span>
        <span class="n">elevations</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_elevation_from_epqs</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">points</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">elevations</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">return</span> <span class="n">elevations</span></div>


<div class="viewcode-block" id="get_elevation_from_epqs"><a class="viewcode-back" href="../../api/index.html#lsmaker.lsmaker.get_elevation_from_epqs">[docs]</a><span class="k">def</span> <span class="nf">get_elevation_from_epqs</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;feet&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns an elevation value at a point location.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    example url for -91, 45:</span>
<span class="sd">        http://nationalmap.gov/epqs/pqs.php?x=-91&amp;y=45&amp;units=Feet&amp;output=json</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; get_elevation_from_epqs(-91, 45)</span>
<span class="sd">    1139.778277</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;http://nationalmap.gov/epqs/pqs.php?&#39;</span>
    <span class="n">url</span> <span class="o">+=</span> <span class="s1">&#39;x=</span><span class="si">{}</span><span class="s1">&amp;y=</span><span class="si">{}</span><span class="s1">&amp;units=</span><span class="si">{}</span><span class="s1">&amp;output=json&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">units</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1">#epqsdata = urlopen(url).readline()</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="n">elev</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)[</span><span class="s1">&#39;USGS_Elevation_Point_Query_Service&#39;</span><span class="p">][</span><span class="s1">&#39;Elevation_Query&#39;</span><span class="p">][</span><span class="s1">&#39;Elevation&#39;</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">elev</span><span class="p">,</span> <span class="n">units</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Problem accessing Elevation Point Query Service. &#39;</span>
              <span class="s1">&#39;Need an internet connection to get seepage lake elevations.&#39;</span>
              <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">If your internet is working, running the script again may work; sometime the EPQS can be temperamental&quot;</span><span class="p">)</span>
        <span class="n">elev</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">elev</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">elev</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">((</span><span class="s1">&#39;Warning, invalid elevation of </span><span class="si">{}</span><span class="s1"> returned for </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">.</span><span class="se">\n</span><span class="s1">Setting elevation to 0.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">elev</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)))</span>
        <span class="n">elev</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">return</span> <span class="n">elev</span></div>


<span class="k">def</span> <span class="nf">_get_random_point_in_polygon</span><span class="p">(</span><span class="n">poly</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generates a point within a polygon (for lakes where the centroid is not in the lake)&quot;&quot;&quot;</span>
    <span class="n">minx</span><span class="p">,</span> <span class="n">miny</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">maxy</span> <span class="o">=</span> <span class="n">poly</span><span class="o">.</span><span class="n">bounds</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">minx</span><span class="p">,</span> <span class="n">maxx</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">miny</span><span class="p">,</span> <span class="n">maxy</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">poly</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">p</span>


<span class="c1">#def reproject(geoms, pr1, pr2):</span>
<span class="c1">#    &quot;&quot;&quot;Reprojects a list of geometries from coordinate system pr1 to pr2</span>
<span class="c1">#    (given as proj strings).&quot;&quot;&quot;</span>
<span class="c1">#    print(&#39;reprojecting from {} to {}...&#39;.format(pr1, pr2))</span>
<span class="c1">#    if not isinstance(geoms, list):</span>
<span class="c1">#        geoms = [geoms]</span>
<span class="c1">#    pr1 = pyproj.Proj(pr1, errcheck=True, preserve_units=True)</span>
<span class="c1">#    pr2 = pyproj.Proj(pr2, errcheck=True, preserve_units=True)</span>
<span class="c1">#    project = partial(pyproj.transform, pr1, pr2)</span>
<span class="c1">#    return [transform(project, g) for g in geoms]</span>


<div class="viewcode-block" id="w_parameter"><a class="viewcode-back" href="../../api/index.html#lsmaker.lsmaker.w_parameter">[docs]</a><span class="k">def</span> <span class="nf">w_parameter</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">lmbda</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute w parameter for estimating an effective conductance term</span>
<span class="sd">    (i.e., when simulating Lakes using Linesinks instead of GFLOW&#39;s lake package)</span>

<span class="sd">    If only larger lakes are simulated (e.g., &gt; 1 km2), w parameter will be = lambda</span>

<span class="sd">    see Haitjema 2005, &quot;Dealing with Resistance to Flow into Surface Waters&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">lmbda</span> <span class="o">&lt;=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">B</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">lmbda</span>
    <span class="k">elif</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">B</span> <span class="o">&lt;</span> <span class="n">lmbda</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">B</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">lmbda</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">B</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">lmbda</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">B</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="n">w</span></div>


<div class="viewcode-block" id="width_from_arboate"><a class="viewcode-back" href="../../api/index.html#lsmaker.lsmaker.width_from_arboate">[docs]</a><span class="k">def</span> <span class="nf">width_from_arboate</span><span class="p">(</span><span class="n">arbolate</span><span class="p">,</span> <span class="n">lmbda</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Estimate stream width in feet from arbolate sum in meters, using relationship</span>
<span class="sd">    described by Feinstein et al (2010), Appendix 2, p 266.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">estwidth</span> <span class="o">=</span> <span class="mf">0.1193</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="n">arbolate</span><span class="p">,</span> <span class="mf">0.5032</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">w_parameter</span><span class="p">(</span><span class="n">estwidth</span><span class="p">,</span> <span class="n">lmbda</span><span class="p">)</span>  <span class="c1"># assumes stream is rep. by single linesink</span>
    <span class="k">return</span> <span class="n">w</span></div>


<div class="viewcode-block" id="lake_width"><a class="viewcode-back" href="../../api/index.html#lsmaker.lsmaker.lake_width">[docs]</a><span class="k">def</span> <span class="nf">lake_width</span><span class="p">(</span><span class="n">area</span><span class="p">,</span> <span class="n">total_line_length</span><span class="p">,</span> <span class="n">lmbda</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Estimate conductance width from lake area and length of flowlines running through it</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">total_line_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">estwidth</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="p">(</span><span class="n">area</span> <span class="o">/</span> <span class="n">total_line_length</span><span class="p">)</span> <span class="o">/</span> <span class="mf">0.3048</span>  <span class="c1"># (km2/km)*(ft/km)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">estwidth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">area</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">/</span> <span class="mf">0.3048</span>  <span class="c1"># (km)*(ft/km)</span>

    <span class="c1"># see Haitjema 2005, &quot;Dealing with Resistance to Flow into Surface Waters&quot;</span>
    <span class="c1"># basically if only larger lakes are simulated (e.g., &gt; 1 km2), w parameter will be = lambda</span>
    <span class="c1"># this assumes that GFLOW&#39;s lake package will not be used</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">w_parameter</span><span class="p">(</span><span class="n">estwidth</span><span class="p">,</span> <span class="n">lmbda</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">w</span>  <span class="c1"># feet</span></div>


<div class="viewcode-block" id="name"><a class="viewcode-back" href="../../api/index.html#lsmaker.lsmaker.name">[docs]</a><span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Abbreviations for naming LinesinkData from names in NHDPlus</span>
<span class="sd">    GFLOW requires linesink names to be 32 characters or less</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">GNIS_NAME</span><span class="p">:</span>
        <span class="c1"># reduce name down with abbreviations</span>
        <span class="n">abb</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Branch&#39;</span><span class="p">:</span> <span class="s1">&#39;Br&#39;</span><span class="p">,</span>
               <span class="s1">&#39;Creek&#39;</span><span class="p">:</span> <span class="s1">&#39;Crk&#39;</span><span class="p">,</span>
               <span class="s1">&#39;East&#39;</span><span class="p">:</span> <span class="s1">&#39;E&#39;</span><span class="p">,</span>
               <span class="s1">&#39;Flowage&#39;</span><span class="p">:</span> <span class="s1">&#39;Fl&#39;</span><span class="p">,</span>
               <span class="s1">&#39;Lake&#39;</span><span class="p">:</span> <span class="s1">&#39;L&#39;</span><span class="p">,</span>
               <span class="s1">&#39;North&#39;</span><span class="p">:</span> <span class="s1">&#39;N&#39;</span><span class="p">,</span>
               <span class="s1">&#39;Pond&#39;</span><span class="p">:</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span>
               <span class="s1">&#39;Reservoir&#39;</span><span class="p">:</span> <span class="s1">&#39;Res&#39;</span><span class="p">,</span>
               <span class="s1">&#39;River&#39;</span><span class="p">:</span> <span class="s1">&#39;R&#39;</span><span class="p">,</span>
               <span class="s1">&#39;South&#39;</span><span class="p">:</span> <span class="s1">&#39;S&#39;</span><span class="p">,</span>
               <span class="s1">&#39;West&#39;</span><span class="p">:</span> <span class="s1">&#39;W&#39;</span><span class="p">,</span>
               <span class="s2">&quot;&#39;&quot;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">}</span>

        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">GNIS_NAME</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">abb</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> unnamed&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">name</span><span class="p">[:</span><span class="mi">32</span><span class="p">]</span></div>


<div class="viewcode-block" id="uniquelist"><a class="viewcode-back" href="../../api/index.html#lsmaker.lsmaker.uniquelist">[docs]</a><span class="k">def</span> <span class="nf">uniquelist</span><span class="p">(</span><span class="n">seq</span><span class="p">):</span>
    <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">seen_add</span> <span class="o">=</span> <span class="n">seen</span><span class="o">.</span><span class="n">add</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">seq</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">seen</span> <span class="ow">or</span> <span class="n">seen_add</span><span class="p">(</span><span class="n">x</span><span class="p">))]</span></div>


<div class="viewcode-block" id="closest_vertex_ind"><a class="viewcode-back" href="../../api/index.html#lsmaker.lsmaker.closest_vertex_ind">[docs]</a><span class="k">def</span> <span class="nf">closest_vertex_ind</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">shape_coords</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns index of closest vertices in shapely geometry object</span>
<span class="sd">    Ugly but works</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">crds</span> <span class="o">=</span> <span class="n">shape_coords</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">crds</span><span class="p">])</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">crds</span><span class="p">])</span>
    <span class="n">dX</span><span class="p">,</span> <span class="n">dY</span> <span class="o">=</span> <span class="n">X</span> <span class="o">-</span> <span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Y</span> <span class="o">-</span> <span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">closest_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dX</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">dY</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">closest_ind</span></div>


<div class="viewcode-block" id="move_point_along_line"><a class="viewcode-back" href="../../api/index.html#lsmaker.lsmaker.move_point_along_line">[docs]</a><span class="k">def</span> <span class="nf">move_point_along_line</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">dist</span><span class="p">):</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">x2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">dist</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">diff</span><span class="p">))</span></div>


<div class="viewcode-block" id="LinesinkData"><a class="viewcode-back" href="../../api/index.html#lsmaker.lsmaker.LinesinkData">[docs]</a><span class="k">class</span> <span class="nc">LinesinkData</span><span class="p">:</span>
    <span class="n">maxlines</span> <span class="o">=</span> <span class="mi">4000</span>

    <span class="n">int_dtype</span> <span class="o">=</span> <span class="nb">str</span>  <span class="c1"># np.int64</span>

    <span class="n">dtypes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Label&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                    <span class="s1">&#39;HeadSpecified&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                    <span class="s1">&#39;StartingHead&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                    <span class="s1">&#39;EndingHead&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                    <span class="s1">&#39;Resistance&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                    <span class="s1">&#39;Width&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                    <span class="s1">&#39;Depth&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                    <span class="s1">&#39;Routing&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span>
                    <span class="s1">&#39;EndStream&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span>
                    <span class="s1">&#39;OverlandFlow&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span>
                    <span class="s1">&#39;EndInflow&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span>
                    <span class="s1">&#39;ScenResistance&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                    <span class="s1">&#39;Drain&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span>
                    <span class="s1">&#39;ScenFluxName&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                    <span class="s1">&#39;Gallery&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span>
                    <span class="s1">&#39;TotalDischarge&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span>
                    <span class="s1">&#39;InletStream&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span>
                    <span class="s1">&#39;OutletStream&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span>
                    <span class="s1">&#39;OutletTable&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                    <span class="s1">&#39;Lake&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span>
                    <span class="s1">&#39;Precipitation&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                    <span class="s1">&#39;Evapotranspiration&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                    <span class="s1">&#39;Farfield&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                    <span class="s1">&#39;chkScenario&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                    <span class="s1">&#39;AutoSWIZC&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span>
                    <span class="s1">&#39;DefaultResistance&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">}</span>

    <span class="n">fcodes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Perennial&#39;</span><span class="p">:</span> <span class="mi">46006</span><span class="p">,</span>
              <span class="s1">&#39;Intermittent&#39;</span><span class="p">:</span> <span class="mi">46003</span><span class="p">,</span>
              <span class="s1">&#39;Uncategorized&#39;</span><span class="p">:</span> <span class="mi">46000</span><span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">infile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">GFLOW_lss_xml</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="c1"># attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lsmaker_config_file_path</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># absolute path to config file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preproc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resistance</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">H</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># aquifer thickness in model units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># hydraulic conductivity of the aquifer in model units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lmbda</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ScenResistance</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chkScenario</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">global_streambed_thickness</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># streambed thickness</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ComputationalUnits</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># &#39;feet&#39; or &#39;meters&#39;; for XML output file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BasemapUnits</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># elevation units multiplier (from NHDPlus cm to model units)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zmult</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># model domain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">farfield</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">routed_area</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nearfield</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">#self.crs_str = None  # self.crs, in proj string format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pyproj_crs</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># pyproj.CRS instance based on prj input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">farfield_buffer</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clip_farfield</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">split_by_HUC</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HUC_shp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HUC_name_field</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># simplification</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refinement_areas</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of n areas within routed area with additional refinement</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nearfield_tolerance</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">routed_area_tolerance</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">farfield_tolerance</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_nearfield_order</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_routed_area_order</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_farfield_order</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_nearfield_wb_size</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_waterbody_size</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_farfield_wb_size</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">farfield_length_threshold</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">routed_area_length_threshold</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drop_intermittent</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drop_crossing</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asum_thresh_ra</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asum_thresh_nf</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asum_thresh_ff</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># NHD files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flowlines</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elevslope</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PlusFlowVAA</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">waterbodies</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># columns to retain in NHD files (when joining to GIS lines)</span>
        <span class="c1"># Note: may need to add method to handle case discrepancies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flowlines_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;COMID&#39;</span><span class="p">,</span> <span class="s1">&#39;FCODE&#39;</span><span class="p">,</span> <span class="s1">&#39;FDATE&#39;</span><span class="p">,</span> <span class="s1">&#39;FLOWDIR&#39;</span><span class="p">,</span> <span class="s1">&#39;FTYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;GNIS_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;GNIS_NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;LENGTHKM&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;REACHCODE&#39;</span><span class="p">,</span> <span class="s1">&#39;RESOLUTION&#39;</span><span class="p">,</span> <span class="s1">&#39;WBAREACOMI&#39;</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flowlines_cols_dtypes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;COMID&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_dtype</span><span class="p">,</span>
                                      <span class="s1">&#39;FCODE&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_dtype</span><span class="p">,</span>
                                      <span class="s1">&#39;FDATE&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                      <span class="s1">&#39;FLOWDIR&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                      <span class="s1">&#39;FTYPE&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                      <span class="s1">&#39;GNIS_ID&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_dtype</span><span class="p">,</span>
                                      <span class="s1">&#39;GNIS_NAME&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                      <span class="s1">&#39;LENGTHKM&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                                      <span class="s1">&#39;REACHCODE&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                      <span class="s1">&#39;RESOLUTION&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                      <span class="s1">&#39;WBAREACOMI&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_dtype</span><span class="p">,</span>
                                      <span class="s1">&#39;geometry&#39;</span><span class="p">:</span> <span class="nb">object</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elevslope_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;MINELEVSMO&#39;</span><span class="p">,</span> <span class="s1">&#39;MAXELEVSMO&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elevslope_dtypes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;MINELEVSMO&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                                 <span class="s1">&#39;MAXELEVSMO&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pfvaa_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ArbolateSu&#39;</span><span class="p">,</span> <span class="s1">&#39;Hydroseq&#39;</span><span class="p">,</span> <span class="s1">&#39;DnHydroseq&#39;</span><span class="p">,</span> <span class="s1">&#39;StreamOrde&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pfvaa_cols_dtypes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ArbolateSu&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                                  <span class="s1">&#39;Hydroseq&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_dtype</span><span class="p">,</span>
                                  <span class="s1">&#39;DnHydroseq&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_dtype</span><span class="p">,</span>
                                  <span class="s1">&#39;StreamOrde&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wb_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;AREASQKM&#39;</span><span class="p">,</span> <span class="s1">&#39;COMID&#39;</span><span class="p">,</span> <span class="s1">&#39;ELEVATION&#39;</span><span class="p">,</span> <span class="s1">&#39;FCODE&#39;</span><span class="p">,</span> <span class="s1">&#39;FDATE&#39;</span><span class="p">,</span> <span class="s1">&#39;FTYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;GNIS_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;GNIS_NAME&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;REACHCODE&#39;</span><span class="p">,</span> <span class="s1">&#39;RESOLUTION&#39;</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wb_cols_dtypes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;AREASQKM&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                               <span class="s1">&#39;COMID&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_dtype</span><span class="p">,</span>
                               <span class="s1">&#39;ELEVATION&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                               <span class="s1">&#39;FCODE&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_dtype</span><span class="p">,</span>
                               <span class="s1">&#39;FDATE&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                               <span class="s1">&#39;FTYPE&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                               <span class="s1">&#39;GNIS_ID&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_dtype</span><span class="p">,</span>
                               <span class="s1">&#39;GNIS_NAME&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                               <span class="s1">&#39;REACHCODE&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                               <span class="s1">&#39;RESOLUTION&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                               <span class="s1">&#39;geometry&#39;</span><span class="p">:</span> <span class="nb">object</span><span class="p">}</span>
        <span class="c1"># could do away with above and have one dtypes list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flowlines_cols_dtypes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elevslope_dtypes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pfvaa_cols_dtypes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wb_cols_dtypes</span><span class="p">)</span>

        <span class="c1"># preprocessed files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DEM</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elevs_field</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DEM_zmult</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">flowlines_clipped</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">waterbodies_clipped</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">routed_mp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">farfield_mp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocessed_lines</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocdir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wb_centroids_w_elevations</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># elevations extracted during preprocessing routine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elevs_field</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># field in wb_centroids_w_elevations containing elevations</span>

        <span class="c1"># outputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outfile_basename</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_reporting</span> <span class="o">=</span> <span class="s1">&#39;error_reporting.txt&#39;</span>

        <span class="c1"># attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">from_lss_xml</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span> <span class="c1"># working dataframe for translating NHDPlus data to linesink strings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lss</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span> <span class="c1"># dataframe of GFLOW linesink strings (with attributes)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outsegs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">confluences</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="c1"># read in the configuration file</span>
        <span class="k">if</span> <span class="n">infile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">infile</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.xml&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_lsmaker_xml</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">infile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">extension</span> <span class="ow">in</span> <span class="s1">&#39;yml&#39;</span><span class="p">,</span> <span class="s1">&#39;yaml&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">infile</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">extension</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">read_lsmaker_yaml</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>

        <span class="c1"># or create instance from a GFLOW LSS XML file</span>
        <span class="k">elif</span> <span class="n">GFLOW_lss_xml</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">from_lss_xml</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_lss</span><span class="p">(</span><span class="n">GFLOW_lss_xml</span><span class="p">)</span>
            
        <span class="c1"># nearfield can&#39;t be coarser than the routed area</span>
        <span class="k">if</span> <span class="n">infile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">min_nearfield_order</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">min_nearfield_order</span><span class="p">,</span> 
                                            <span class="bp">self</span><span class="o">.</span><span class="n">min_routed_area_order</span><span class="p">))</span>
        <span class="c1"># create a pyproj CRS instance</span>
        <span class="c1"># set the CRS (basemap) length units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_crs</span><span class="p">(</span><span class="n">prjfile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">prj</span><span class="p">)</span>

        <span class="c1"># logging/diagnostics</span>
        <span class="c1"># todo: more robust/detail logging</span>
        <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error_reporting</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error_reporting</span><span class="p">)</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">j</span><span class="o">=</span><span class="mi">2</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error_reporting</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">efp</span><span class="p">:</span>
            <span class="n">efp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Linesink-maker version </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lsmaker</span><span class="o">.</span><span class="n">__version__</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dg</span> <span class="o">=</span> <span class="n">Diagnostics</span><span class="p">(</span><span class="n">lsm_object</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">logfile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">error_reporting</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test for equality to another linesink object.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">exclude_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_lsmaker_config_file_path&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;crs&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;crs_str&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;inpars&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;cfg&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;efp&#39;</span><span class="p">,</span>
                         <span class="p">]</span>
        <span class="c1"># LinesinkData instances from lss xml won&#39;t have some attributes</span>
        <span class="c1"># or some df columns that came from NHDPlus</span>
        <span class="n">compare_df_columns</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_lss_xml</span> <span class="ow">or</span> <span class="n">other</span><span class="o">.</span><span class="n">from_lss_xml</span><span class="p">:</span>
            <span class="c1"># todo: expose default values that are being set on write of lss_xml</span>
            <span class="c1"># (many of the columns in LinesinkData instance from lss xml aren&#39;t in</span>
            <span class="c1"># LinesinkData instance that was created from scratch, because the variables</span>
            <span class="c1"># are only being set in LinesinkData.write_lss method)</span>
            <span class="n">compare_df_columns</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="c1"># the geometries and coordinates won&#39;t be exactly the same</span>
            <span class="c1"># explicitly compare the coordinates separately</span>
            <span class="n">compare_df_columns</span> <span class="o">=</span> <span class="n">compare_df_columns</span><span class="o">.</span><span class="n">difference</span><span class="p">({</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span>
                                                                <span class="s1">&#39;ls_coords&#39;</span><span class="p">,</span>
                                                                <span class="s1">&#39;width&#39;</span>
                                                                <span class="p">})</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># items to skip</span>
            <span class="c1"># todo: implement pyproj.CRS class to robustly compare CRSs</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">exclude_attrs</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_lss_xml</span> <span class="ow">or</span> <span class="n">other</span><span class="o">.</span><span class="n">from_lss_xml</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;df&#39;</span><span class="p">,</span> <span class="s1">&#39;ComputationalUnits&#39;</span><span class="p">,</span> <span class="s1">&#39;BasemapUnits&#39;</span><span class="p">):</span>
                    <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="nb">bool</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;df&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">df1</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">compare_df_columns</span><span class="p">]</span>
                    <span class="n">df2</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">compare_df_columns</span><span class="p">]</span>
                    <span class="c1">#</span>
                    <span class="n">pd</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_frame_equal</span><span class="p">(</span><span class="n">df1</span><span class="p">,</span> <span class="n">df2</span><span class="p">)</span>
                    <span class="c1"># compare the coordinates</span>
                    <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># (x, y)</span>
                        <span class="n">x1</span> <span class="o">=</span> <span class="p">[</span><span class="n">crd</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">ls_coords</span> <span class="k">for</span> <span class="n">crd</span> <span class="ow">in</span> <span class="n">line</span><span class="p">]</span>
                        <span class="n">x2</span> <span class="o">=</span> <span class="p">[</span><span class="n">crd</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">ls_coords</span> <span class="k">for</span> <span class="n">crd</span> <span class="ow">in</span> <span class="n">line</span><span class="p">]</span>
                        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">width</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">width</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">pd</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_frame_equal</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>

            <span class="k">elif</span> <span class="n">v</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">k</span><span class="p">]):</span>
                        <span class="k">return</span> <span class="kc">False</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">continue</span>
                    <span class="c1">#return False</span>
            <span class="c1">#elif type(v) in [str, int, float, dict, list]:</span>
            <span class="c1">#    if v != other.__dict__[k]:</span>
            <span class="c1">#        pass</span>
            <span class="c1">#    continue</span>
        
<div class="viewcode-block" id="LinesinkData.read_lsmaker_xml"><a class="viewcode-back" href="../../api/index.html#lsmaker.lsmaker.LinesinkData.read_lsmaker_xml">[docs]</a>    <span class="k">def</span> <span class="nf">read_lsmaker_xml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">infile</span><span class="p">):</span>

        <span class="c1">#try:</span>
        <span class="n">inpardat</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
        <span class="c1">#except:</span>
        <span class="c1">#    raise InputFileMissing</span>

        <span class="c1"># record the config file absolute path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lsmaker_config_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">infile</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">inpars</span> <span class="o">=</span> <span class="n">inpardat</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inpars</span> <span class="o">=</span> <span class="n">inpars</span>

        <span class="c1"># setup the working directory (default to current directory)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">inpars</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;.//working_dir&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lsmaker_config_file_path</span>

        <span class="c1"># global settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preproc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tf2flag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_xml_entry</span><span class="p">(</span><span class="s1">&#39;preproc&#39;</span><span class="p">,</span> <span class="s1">&#39;True&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resistance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_xml_entry</span><span class="p">(</span><span class="s1">&#39;resistance&#39;</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>  <span class="c1"># (days); c in documentation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_xml_entry</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="c1"># aquifer thickness in model units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_xml_entry</span><span class="p">(</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>  <span class="c1"># hydraulic conductivity of the aquifer in model units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lmbda</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">resistance</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ScenResistance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_xml_entry</span><span class="p">(</span><span class="s1">&#39;ScenResistance&#39;</span><span class="p">,</span> <span class="s1">&#39;linesink&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chkScenario</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tf2flag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_xml_entry</span><span class="p">(</span><span class="s1">&#39;chkScenario&#39;</span><span class="p">,</span> <span class="s1">&#39;True&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">global_streambed_thickness</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_xml_entry</span><span class="p">(</span><span class="s1">&#39;global_streambed_thickness&#39;</span><span class="p">,</span>
                                                              <span class="mi">3</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>  <span class="c1"># streambed thickness</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ComputationalUnits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_xml_entry</span><span class="p">(</span><span class="s1">&#39;ComputationalUnits&#39;</span><span class="p">,</span> <span class="s1">&#39;feet&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="c1"># &#39;feet&#39; or &#39;meters&#39;; for XML output file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BasemapUnits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_xml_entry</span><span class="p">(</span><span class="s1">&#39;BasemapUnits&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">BasemapUnits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">BasemapUnits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BasemapUnits</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="c1"># elevation units multiplier (from NHDPlus cm to model units)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zmult</span> <span class="o">=</span> <span class="mf">0.03280839895013123</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ComputationalUnits</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;feet&#39;</span> <span class="k">else</span> <span class="mf">0.01</span>

        <span class="c1"># model domain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">farfield</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_xml_entry</span><span class="p">(</span><span class="s1">&#39;farfield&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">routed_area</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_xml_entry</span><span class="p">(</span><span class="s1">&#39;routed_area&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nearfield</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_xml_entry</span><span class="p">(</span><span class="s1">&#39;nearfield&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span> <span class="c1"># get the projection file and crs from either the nearfield or routed area</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_xml_entry</span><span class="p">(</span><span class="s1">&#39;prj&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nearfield</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.prj&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="n">fiona</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nearfield</span><span class="p">)</span><span class="o">.</span><span class="n">crs</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_xml_entry</span><span class="p">(</span><span class="s1">&#39;prj&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">routed_area</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.prj&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="n">fiona</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">routed_area</span><span class="p">)</span><span class="o">.</span><span class="n">crs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nearfield</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">routed_area</span>
        <span class="c1">#self.crs_str = str(self.crs)  # self.crs, in proj string format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">farfield_buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_xml_entry</span><span class="p">(</span><span class="s1">&#39;farfield_buffer&#39;</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clip_farfield</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tf2flag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_xml_entry</span><span class="p">(</span><span class="s1">&#39;clip_farfield&#39;</span><span class="p">,</span> <span class="s1">&#39;False&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">split_by_HUC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tf2flag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_xml_entry</span><span class="p">(</span><span class="s1">&#39;split_by_HUC&#39;</span><span class="p">,</span> <span class="s1">&#39;False&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HUC_shp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_xml_entry</span><span class="p">(</span><span class="s1">&#39;HUC_shp&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HUC_name_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tf2flag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_xml_entry</span><span class="p">(</span><span class="s1">&#39;HUC_name_field&#39;</span><span class="p">,</span> <span class="s1">&#39;False&#39;</span><span class="p">))</span>

        <span class="c1"># simplification</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refinement_areas</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of n areas within routed area with additional refinement</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nearfield_tolerance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_xml_entry</span><span class="p">(</span><span class="s1">&#39;nearfield_tolerance&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">routed_area_tolerance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_xml_entry</span><span class="p">(</span><span class="s1">&#39;routed_area_tolerance&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">farfield_tolerance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_xml_entry</span><span class="p">(</span><span class="s1">&#39;farfield_tolerance&#39;</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_farfield_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_xml_entry</span><span class="p">(</span><span class="s1">&#39;min_farfield_order&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_nearfield_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_xml_entry</span><span class="p">(</span><span class="s1">&#39;min_nearfield_order&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_routed_area_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_xml_entry</span><span class="p">(</span><span class="s1">&#39;min_routed_area_order&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_nearfield_wb_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_xml_entry</span><span class="p">(</span><span class="s1">&#39;min_nearfield_waterbody_size&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_waterbody_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_xml_entry</span><span class="p">(</span><span class="s1">&#39;min_waterbody_size&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_farfield_wb_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_xml_entry</span><span class="p">(</span><span class="s1">&#39;min_farfield_waterbody_size&#39;</span><span class="p">,</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">min_waterbody_size</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">farfield_length_threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_xml_entry</span><span class="p">(</span><span class="s1">&#39;farfield_length_threshold&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">routed_area_length_threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_xml_entry</span><span class="p">(</span><span class="s1">&#39;routed_area_length_threshold&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drop_intermittent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tf2flag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_xml_entry</span><span class="p">(</span><span class="s1">&#39;drop_intermittent&#39;</span><span class="p">,</span> <span class="s1">&#39;False&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drop_crossing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tf2flag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_xml_entry</span><span class="p">(</span><span class="s1">&#39;drop_crossing&#39;</span><span class="p">,</span> <span class="s1">&#39;False&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asum_thresh_ra</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_xml_entry</span><span class="p">(</span><span class="s1">&#39;routed_area_arbolate_sum_threshold&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asum_thresh_nf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_xml_entry</span><span class="p">(</span><span class="s1">&#39;nearfield_arbolate_sum_threshold&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asum_thresh_ff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_xml_entry</span><span class="p">(</span><span class="s1">&#39;farfield_arbolate_sum_threshold&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>

        <span class="c1"># NHD files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flowlines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_xml_entry</span><span class="p">(</span><span class="s1">&#39;flowlines&#39;</span><span class="p">,</span> <span class="p">[],</span> <span class="nb">str</span><span class="p">,</span> <span class="n">raise_error</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elevslope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_xml_entry</span><span class="p">(</span><span class="s1">&#39;elevslope&#39;</span><span class="p">,</span> <span class="p">[],</span> <span class="nb">str</span><span class="p">,</span> <span class="n">raise_error</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PlusFlowVAA</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_xml_entry</span><span class="p">(</span><span class="s1">&#39;PlusFlowVAA&#39;</span><span class="p">,</span> <span class="p">[],</span> <span class="nb">str</span><span class="p">,</span> <span class="n">raise_error</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">waterbodies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_xml_entry</span><span class="p">(</span><span class="s1">&#39;waterbodies&#39;</span><span class="p">,</span> <span class="p">[],</span> <span class="nb">str</span><span class="p">,</span> <span class="n">raise_error</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># columns to retain in NHD files (when joining to GIS lines)</span>
        <span class="c1"># Note: may need to add method to handle case discrepancies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flowlines_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;COMID&#39;</span><span class="p">,</span> <span class="s1">&#39;FCODE&#39;</span><span class="p">,</span> <span class="s1">&#39;FDATE&#39;</span><span class="p">,</span> <span class="s1">&#39;FLOWDIR&#39;</span><span class="p">,</span> <span class="s1">&#39;FTYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;GNIS_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;GNIS_NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;LENGTHKM&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;REACHCODE&#39;</span><span class="p">,</span> <span class="s1">&#39;RESOLUTION&#39;</span><span class="p">,</span> <span class="s1">&#39;WBAREACOMI&#39;</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flowlines_cols_dtypes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;COMID&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_dtype</span><span class="p">,</span>
                                      <span class="s1">&#39;FCODE&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_dtype</span><span class="p">,</span>
                                      <span class="s1">&#39;FDATE&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                      <span class="s1">&#39;FLOWDIR&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                      <span class="s1">&#39;FTYPE&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                      <span class="s1">&#39;GNIS_ID&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_dtype</span><span class="p">,</span>
                                      <span class="s1">&#39;GNIS_NAME&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                      <span class="s1">&#39;LENGTHKM&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                                      <span class="s1">&#39;REACHCODE&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                      <span class="s1">&#39;RESOLUTION&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                      <span class="s1">&#39;WBAREACOMI&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_dtype</span><span class="p">,</span>
                                      <span class="s1">&#39;geometry&#39;</span><span class="p">:</span> <span class="nb">object</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elevslope_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;MINELEVSMO&#39;</span><span class="p">,</span> <span class="s1">&#39;MAXELEVSMO&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elevslope_dtypes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;MINELEVSMO&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                                 <span class="s1">&#39;MAXELEVSMO&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pfvaa_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ArbolateSu&#39;</span><span class="p">,</span> <span class="s1">&#39;Hydroseq&#39;</span><span class="p">,</span> <span class="s1">&#39;DnHydroseq&#39;</span><span class="p">,</span> <span class="s1">&#39;StreamOrde&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pfvaa_cols_dtypes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ArbolateSu&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                                  <span class="s1">&#39;Hydroseq&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_dtype</span><span class="p">,</span>
                                  <span class="s1">&#39;DnHydroseq&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_dtype</span><span class="p">,</span>
                                  <span class="s1">&#39;StreamOrde&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wb_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;AREASQKM&#39;</span><span class="p">,</span> <span class="s1">&#39;COMID&#39;</span><span class="p">,</span> <span class="s1">&#39;ELEVATION&#39;</span><span class="p">,</span> <span class="s1">&#39;FCODE&#39;</span><span class="p">,</span> <span class="s1">&#39;FDATE&#39;</span><span class="p">,</span> <span class="s1">&#39;FTYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;GNIS_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;GNIS_NAME&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;REACHCODE&#39;</span><span class="p">,</span> <span class="s1">&#39;RESOLUTION&#39;</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wb_cols_dtypes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;AREASQKM&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                               <span class="s1">&#39;COMID&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_dtype</span><span class="p">,</span>
                               <span class="s1">&#39;ELEVATION&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                               <span class="s1">&#39;FCODE&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_dtype</span><span class="p">,</span>
                               <span class="s1">&#39;FDATE&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                               <span class="s1">&#39;FTYPE&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                               <span class="s1">&#39;GNIS_ID&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_dtype</span><span class="p">,</span>
                               <span class="s1">&#39;GNIS_NAME&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                               <span class="s1">&#39;REACHCODE&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                               <span class="s1">&#39;RESOLUTION&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                               <span class="s1">&#39;geometry&#39;</span><span class="p">:</span> <span class="nb">object</span><span class="p">}</span>
        <span class="c1"># could do away with above and have one dtypes list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flowlines_cols_dtypes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elevslope_dtypes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pfvaa_cols_dtypes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wb_cols_dtypes</span><span class="p">)</span>

        <span class="c1"># preprocessed files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DEM</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_xml_entry</span><span class="p">(</span><span class="s1">&#39;DEM&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elevs_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_xml_entry</span><span class="p">(</span><span class="s1">&#39;elevs_field&#39;</span><span class="p">,</span> <span class="s1">&#39;elev&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DEM_zmult</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_xml_entry</span><span class="p">(</span><span class="s1">&#39;DEM_zmult&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">flowlines_clipped</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_xml_entry</span><span class="p">(</span><span class="s1">&#39;flowlines_clipped&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;preprocessed/flowlines_clipped.shp&#39;</span><span class="p">,</span>
                                                     <span class="n">relative_filepath</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">waterbodies_clipped</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_xml_entry</span><span class="p">(</span><span class="s1">&#39;waterbodies_clipped&#39;</span><span class="p">,</span>
                                                      <span class="s1">&#39;preprocessed/waterbodies_clipped.shp&#39;</span><span class="p">,</span>
                                                       <span class="n">relative_filepath</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">routed_mp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_xml_entry</span><span class="p">(</span><span class="s1">&#39;routed_area_multipolygon&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;preprocessed/ra_cutout.shp&#39;</span><span class="p">,</span>
                                             <span class="n">relative_filepath</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">farfield_mp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_xml_entry</span><span class="p">(</span><span class="s1">&#39;farfield_multipolygon&#39;</span><span class="p">,</span>
                                              <span class="s1">&#39;preprocessed/ff_cutout.shp&#39;</span><span class="p">,</span>
                                               <span class="n">relative_filepath</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocessed_lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_xml_entry</span><span class="p">(</span><span class="s1">&#39;preprocessed_lines&#39;</span><span class="p">,</span>
                                                     <span class="s1">&#39;preprocessed/lines.shp&#39;</span><span class="p">,</span>
                                                      <span class="n">relative_filepath</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flowlines_clipped</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wb_centroids_w_elevations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">waterbodies_clipped</span><span class="p">[</span>
                                         <span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_points.shp&#39;</span>  <span class="c1"># elevations extracted during preprocessing routine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elevs_field</span> <span class="o">=</span> <span class="s1">&#39;DEM&#39;</span>  <span class="c1"># field in wb_centroids_w_elevations containing elevations</span>

        <span class="c1"># outputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outfile_basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lsmaker_config_file_path</span><span class="p">,</span>
                                             <span class="n">inpars</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;.//outfile_basename&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_reporting</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lsmaker_config_file_path</span><span class="p">,</span>
                                            <span class="n">inpars</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;.//error_reporting&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

        <span class="c1"># attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span> <span class="c1"># working dataframe for translating NHDPlus data to linesink strings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lss</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span> <span class="c1"># dataframe of GFLOW linesink strings (with attributes)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outsegs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">confluences</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span></div>

<div class="viewcode-block" id="LinesinkData.read_lsmaker_yaml"><a class="viewcode-back" href="../../api/index.html#lsmaker.lsmaker.LinesinkData.read_lsmaker_yaml">[docs]</a>    <span class="k">def</span> <span class="nf">read_lsmaker_yaml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">infile</span><span class="p">):</span>

        <span class="c1"># read in the user-specified configuration</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">yaml</span><span class="o">.</span><span class="n">Loader</span><span class="p">)</span>
        <span class="c1"># read in the default configuration</span>
        <span class="n">defaults_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> 
                                     <span class="s1">&#39;default_settings.yml&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">defaults_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="n">defaults</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">yaml</span><span class="o">.</span><span class="n">Loader</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_lsmaker_config_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">infile</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># configuration dictionary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="n">cfg</span>

        <span class="c1"># configuration file blocks</span>
        <span class="n">filepaths_to_make_abs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;outfile_basename&#39;</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">blockname</span><span class="p">,</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">defaults</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># entries within blocks</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span> <span class="ow">in</span> <span class="n">defaults</span><span class="p">[</span><span class="n">blockname</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># try to detect files and make their paths absolute</span>
                <span class="n">entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">blockname</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">file_abspath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lsmaker_config_file_path</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_abspath</span><span class="p">)</span> <span class="ow">or</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">filepaths_to_make_abs</span><span class="p">:</span>
                        <span class="n">entry</span> <span class="o">=</span> <span class="n">file_abspath</span>
                <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span>
                
        <span class="c1"># setup the working directory (default to current directory)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;working_dir&#39;</span><span class="p">))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">lmbda</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">resistance</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zmult</span> <span class="o">=</span> <span class="mf">0.03280839895013123</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ComputationalUnits</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;feet&#39;</span> <span class="k">else</span> <span class="mf">0.01</span>
            
        <span class="c1"># get the projection file and crs from either the nearfield or routed area</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nearfield</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">routed_area</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">name</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                    <span class="n">prjfile</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.prj&#39;</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">prjfile</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">prj</span> <span class="o">=</span> <span class="n">prjfile</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="n">gisutils</span><span class="o">.</span><span class="n">get_shapefile_crs</span><span class="p">(</span><span class="n">prjfile</span><span class="p">)</span>
                        <span class="c1">#with fiona.open(filename) as src:</span>
                        <span class="c1">#    self.crs = src.crs</span>
                        <span class="c1">#    self.crs_str = to_string(self.crs)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#self.crs_str = gisutils.get_proj_str(self.prj)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="n">gisutils</span><span class="o">.</span><span class="n">get_shapefile_crs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prj</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">crs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">prj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Invalid projection file or projection file not found: </span><span class="si">{}</span><span class="s2">. </span><span class="se">\</span>
<span class="s2">                Specify a valid ESRI projection file under the </span><span class="se">\</span>
<span class="s2">                prj: configuration file key&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prj</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># NHDPlus files</span>
        <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="s1">&#39;flowlines&#39;</span><span class="p">,</span> <span class="s1">&#39;elevslope&#39;</span><span class="p">,</span> <span class="s1">&#39;PlusFlowVAA&#39;</span><span class="p">,</span> <span class="s1">&#39;waterbodies&#39;</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Nothing specified for </span><span class="si">{}</span><span class="s1"> in the configuration file!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">variable</span><span class="p">))</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;file not found: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>

        <span class="c1"># preprocessed files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flowlines_clipped</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wb_centroids_w_elevations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">waterbodies_clipped</span><span class="p">[</span>
                                         <span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_points.shp&#39;</span>  <span class="c1"># elevations extracted during preprocessing routine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elevs_field</span> <span class="o">=</span> <span class="s1">&#39;DEM&#39;</span>  <span class="c1"># field in wb_centroids_w_elevations containing elevations</span></div>
        
    <span class="k">def</span> <span class="nf">_parse_xml_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">findall_result</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">relative_filepath</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># handle either strings or lxml Elements</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">findall_result</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="n">findall_result</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="c1"># check if a file exists relative to config file path</span>
            <span class="c1"># if so, change the file path to be absolute</span>
            <span class="n">file_abspath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lsmaker_config_file_path</span><span class="p">,</span> <span class="n">txt</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_abspath</span><span class="p">)</span> <span class="ow">or</span> <span class="n">relative_filepath</span><span class="p">:</span>
                <span class="n">txt</span> <span class="o">=</span> <span class="n">file_abspath</span>
        <span class="k">return</span> <span class="n">dtype</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span> <span class="k">if</span> <span class="n">txt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_get_xml_entry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">XMLentry</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                       <span class="n">relative_filepath</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">raise_error</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inpars</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;.//</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">XMLentry</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">raise_error</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">relative_filepath</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">default</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">raise_error</span> <span class="ow">and</span> <span class="n">relative_filepath</span><span class="p">:</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="p">[</span><span class="n">default</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">default</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Nothing specified for </span><span class="si">{}</span><span class="s1"> in input XML file!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">XMLentry</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># and not isinstance(default, list):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_xml_text</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">relative_filepath</span><span class="o">=</span><span class="n">relative_filepath</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_parse_xml_text</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">relative_filepath</span><span class="o">=</span><span class="n">relative_filepath</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">tmp</span><span class="p">]</span>
                <span class="c1">#return [dtype(s.text) for s in tmp]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">raise_error</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">default</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Nothing specified for </span><span class="si">{}</span><span class="s1"> in input XML file!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">XMLentry</span><span class="p">))</span>
            
    <span class="k">def</span> <span class="nf">_enforce_dtypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Ensure that dataframe column dtypes are correct.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="c1"># handle Nonetype values in some NHDPlus fields</span>
                <span class="n">j</span><span class="o">=</span><span class="mi">2</span>
                <span class="k">continue</span>

    <span class="k">def</span> <span class="nf">_get_wb_elevations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wb_df</span><span class="p">):</span>
        <span class="c1"># (the centroids of some lakes might not be in the lake itself)</span>
        <span class="n">wb_points</span> <span class="o">=</span> <span class="p">[</span><span class="n">wb</span><span class="o">.</span><span class="n">centroid</span> <span class="k">if</span> <span class="n">wb</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">within</span><span class="p">(</span><span class="n">wb</span><span class="p">)</span>
                     <span class="k">else</span> <span class="n">_get_random_point_in_polygon</span><span class="p">(</span><span class="n">wb</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">wb</span> <span class="ow">in</span> <span class="n">wb_df</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span>
        <span class="c1"># reproject the representative points into lat lon</span>
        <span class="n">wb_points_ll</span> <span class="o">=</span> <span class="n">gisutils</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">wb_points</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span> <span class="s2">&quot;epsg:4269&quot;</span><span class="p">)</span>
        <span class="n">wb_elevations</span> <span class="o">=</span> <span class="n">get_elevations_from_epqs</span><span class="p">(</span><span class="n">wb_points_ll</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ComputationalUnits</span><span class="p">)</span>

        <span class="c1"># add in elevations from waterbodies in stream network</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;COMID&#39;</span><span class="p">:</span> <span class="n">wb_df</span><span class="o">.</span><span class="n">COMID</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">elevs_field</span><span class="p">:</span> <span class="n">wb_elevations</span><span class="p">,</span>
                                     <span class="s1">&#39;geometry&#39;</span><span class="p">:</span> <span class="n">wb_points</span><span class="p">})</span>

<div class="viewcode-block" id="LinesinkData.load_poly"><a class="viewcode-back" href="../../api/index.html#lsmaker.lsmaker.LinesinkData.load_poly">[docs]</a>    <span class="k">def</span> <span class="nf">load_poly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shapefile</span><span class="p">,</span> <span class="n">dest_crs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load a shapefile and return the first polygon from its records,</span>
<span class="sd">        projected in the destination coordinate system.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dest_crs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dest_crs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dest_crs</span> <span class="o">=</span> <span class="n">gisutils</span><span class="o">.</span><span class="n">get_authority_crs</span><span class="p">(</span><span class="n">dest_crs</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;reading </span><span class="si">{}</span><span class="s1">...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">shapefile</span><span class="p">))</span>
        <span class="k">with</span> <span class="n">fiona</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">shapefile</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="n">geom</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">src</span><span class="p">))[</span><span class="s1">&#39;geometry&#39;</span><span class="p">])</span>
        <span class="n">shp_crs</span> <span class="o">=</span> <span class="n">gisutils</span><span class="o">.</span><span class="n">get_shapefile_crs</span><span class="p">(</span><span class="n">shapefile</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">shp_crs</span> <span class="o">!=</span> <span class="n">dest_crs</span><span class="p">:</span>
            <span class="n">geom</span> <span class="o">=</span> <span class="n">gisutils</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">shp_crs</span><span class="p">,</span> <span class="n">dest_crs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">geom</span></div>

<div class="viewcode-block" id="LinesinkData.tf2flag"><a class="viewcode-back" href="../../api/index.html#lsmaker.lsmaker.LinesinkData.tf2flag">[docs]</a>    <span class="k">def</span> <span class="nf">tf2flag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">intxt</span><span class="p">):</span>
        <span class="c1"># converts text written in XML file to True or False flag</span>
        <span class="k">if</span> <span class="n">intxt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">intxt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="LinesinkData.set_crs"><a class="viewcode-back" href="../../api/index.html#lsmaker.lsmaker.LinesinkData.set_crs">[docs]</a>    <span class="k">def</span> <span class="nf">set_crs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epsg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">proj_str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prjfile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the projected coordinate reference system, and the BasemapUnits.</span>
<span class="sd">        If no arguments are supplied, default to existing BasemapUnits.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        epsg: int</span>
<span class="sd">            EPSG code identifying Coordinate Reference System (CRS)</span>
<span class="sd">            for features in df.geometry</span>
<span class="sd">            (optional)</span>
<span class="sd">        proj_str: str</span>
<span class="sd">            proj_str string identifying CRS for features in df.geometry</span>
<span class="sd">            (optional)</span>
<span class="sd">        prjfile: str</span>
<span class="sd">            File path to projection (.prj) file identifying CRS</span>
<span class="sd">            for features in df.geometry</span>
<span class="sd">            (optional)</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        sets the LinesinkData.pyproj_crs attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">arg</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="p">(</span><span class="n">epsg</span><span class="p">,</span> <span class="n">proj_str</span><span class="p">,</span> <span class="n">prjfile</span><span class="p">))</span>
        <span class="n">pyproj_crs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">BasemapUnits</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">epsg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pyproj_crs</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">CRS</span><span class="o">.</span><span class="n">from_epsg</span><span class="p">(</span><span class="n">epsg</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">proj_str</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pyproj_crs</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">CRS</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">proj_str</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">prjfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">prjfile</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
                    <span class="n">wkt</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">pyproj_crs</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">CRS</span><span class="o">.</span><span class="n">from_wkt</span><span class="p">(</span><span class="n">wkt</span><span class="p">)</span>
            <span class="c1"># if possible, have pyproj try to find the closest</span>
            <span class="c1"># authority name and code matching the crs</span>
            <span class="c1"># so that input from epsg codes, proj strings, and prjfiles</span>
            <span class="c1"># results in equal pyproj_crs instances</span>
            <span class="k">if</span> <span class="n">pyproj_crs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">authority</span> <span class="o">=</span> <span class="n">pyproj_crs</span><span class="o">.</span><span class="n">to_authority</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">authority</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pyproj_crs</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">CRS</span><span class="o">.</span><span class="n">from_user_input</span><span class="p">(</span><span class="n">pyproj_crs</span><span class="o">.</span><span class="n">to_authority</span><span class="p">())</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pyproj_crs</span> <span class="o">=</span> <span class="n">pyproj_crs</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="n">units</span> <span class="o">=</span> <span class="n">pyproj_crs</span><span class="o">.</span><span class="n">axis_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unit_name</span>
                <span class="n">translate_units</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;metre&#39;</span><span class="p">:</span> <span class="s1">&#39;meters&#39;</span><span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">BasemapUnits</span> <span class="o">=</span> <span class="n">translate_units</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="n">units</span><span class="p">)</span></div>
            
<div class="viewcode-block" id="LinesinkData.preprocess"><a class="viewcode-back" href="../../api/index.html#lsmaker.lsmaker.LinesinkData.preprocess">[docs]</a>    <span class="k">def</span> <span class="nf">preprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method associates attribute information in the NHDPlus PlusFlowVAA and Elevslope tables, and</span>
<span class="sd">        the model domain configuration (nearfield, farfield, and any other polygon areas) with the NHDPlus</span>
<span class="sd">        Flowlines and Waterbodies datasets. The following edits are made to the Flowlines and waterbodies:</span>
<span class="sd">        * remove farfield streams lower than &lt;min_farfield_order&gt;</span>
<span class="sd">        * remove waterbodies that aren&#39;t lakes, and lakes smaller than &lt;min_waterbody_size&gt;</span>
<span class="sd">        * convert lakes from polygons to lines; merge the lakes with the with flowlines</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        save: True/False</span>
<span class="sd">            Saves the preprocessed dataset to a shapefile specified by &lt;preprocessed_lines&gt; in the XML input file</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">routed_area</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">routed_area</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nearfield</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">routed_area_tolerance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nearfield_tolerance</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nearfield</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">routed_area</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InputFileMissing</span><span class="p">(</span><span class="s1">&#39;Need to supply shapefile of routed area or nearfield.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">farfield</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">((</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">No farfield shapefile supplied.</span><span class="se">\n</span><span class="s1">&#39;</span>
                  <span class="s1">&#39;Creating farfield using buffer of </span><span class="si">{:.1f}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> around routed area.</span><span class="se">\n</span><span class="s1">&#39;</span>
                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">farfield_buffer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">BasemapUnits</span><span class="p">)))</span>
            <span class="n">modelareafile</span> <span class="o">=</span> <span class="n">fiona</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">routed_area</span><span class="p">)</span>
            <span class="n">nfarea</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">modelareafile</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;geometry&#39;</span><span class="p">])</span>
            <span class="n">modelarea_farfield</span> <span class="o">=</span> <span class="n">nfarea</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">farfield_buffer</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">farfield</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nearfield</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_ff.shp&#39;</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">fiona</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">farfield</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span>
                                <span class="n">crs</span><span class="o">=</span><span class="n">modelareafile</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
                                <span class="n">schema</span><span class="o">=</span><span class="n">modelareafile</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span>
                                <span class="n">driver</span><span class="o">=</span><span class="n">modelareafile</span><span class="o">.</span><span class="n">driver</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;properties&#39;</span><span class="p">:</span> <span class="n">modelareafile</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;properties&#39;</span><span class="p">],</span>
                          <span class="s1">&#39;geometry&#39;</span><span class="p">:</span> <span class="n">mapping</span><span class="p">(</span><span class="n">modelarea_farfield</span><span class="p">)})</span>
            <span class="n">output</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># make the output directory if it doesn&#39;t exist yet</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">preprocdir</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">preprocdir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">preprocdir</span><span class="p">)</span>

        <span class="c1"># make projection file that is independent of any shapefile</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;GFLOW.prj&#39;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;GFLOW.prj&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prj</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prj</span><span class="p">,</span> <span class="s1">&#39;GFLOW.prj&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prj</span> <span class="o">=</span> <span class="s1">&#39;GFLOW.prj&#39;</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;clipping and reprojecting input datasets...&#39;</span><span class="p">)</span>

        <span class="c1"># (zero buffers can clean up self-intersections in hand drawn polygons)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_poly</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nearfield</span><span class="p">)</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ra</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_poly</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">routed_area</span><span class="p">)</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_poly</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">farfield</span><span class="p">)</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ff</span><span class="p">]:</span>
            <span class="k">assert</span> <span class="n">p</span><span class="o">.</span><span class="n">is_valid</span><span class="p">,</span> <span class="s1">&#39;Invalid polygon&#39;</span>

        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">shapefiles</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">({</span><span class="s1">&#39;fl&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">flowlines</span><span class="p">,</span>
                                      <span class="s1">&#39;wb&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">waterbodies</span><span class="p">}</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="c1"># all flowlines and waterbodies must be in same coordinate system</span>
            <span class="c1"># sfrmaker preproc also uses crs from first file in list</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">shapefiles</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">shapefile</span> <span class="o">=</span> <span class="n">shapefiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">shapefile</span> <span class="o">=</span> <span class="n">shapefiles</span>
            <span class="n">shp_crs</span> <span class="o">=</span> <span class="n">gisutils</span><span class="o">.</span><span class="n">get_shapefile_crs</span><span class="p">(</span><span class="n">shapefile</span><span class="p">)</span>

            <span class="c1"># get bounding box of model area in nhd crs to speeding reading in data via filter</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="n">gisutils</span><span class="o">.</span><span class="n">project</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">ff</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span> <span class="n">shp_crs</span><span class="p">)</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bounds</span>

            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">gisutils</span><span class="o">.</span><span class="n">shp2df</span><span class="p">(</span><span class="n">shapefiles</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="n">bounds</span><span class="p">)</span>
            <span class="c1"># if NHD features not in model area coodinate system, reproject</span>
            <span class="k">if</span> <span class="n">shp_crs</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">attr</span><span class="p">][</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gisutils</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">shp_crs</span><span class="p">,</span>
                                                            <span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
            <span class="c1"># 1816107</span>
            <span class="c1"># for now, take intersection (don&#39;t truncate flowlines at farfield boundary)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;clipping to </span><span class="si">{}</span><span class="s1">...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">farfield</span><span class="p">))</span>
            <span class="n">intersects</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">l</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ff</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">geometry</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">attr</span><span class="p">][</span><span class="n">intersects</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clip_farfield</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;truncating waterbodies at farfield boundary...&#39;</span><span class="p">)</span>
            <span class="c1"># get rid of any islands in the process</span>
            <span class="n">wbgeoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wb</span><span class="o">.</span><span class="n">geometry</span>
            <span class="c1"># valid = np.array([p.is_valid for p in wbgeoms])</span>
            <span class="c1"># if np.any(~valid):</span>
            <span class="c1">#    comids = self.wb.loc[~valid, &#39;COMID&#39;]</span>
            <span class="c1">#    print(&#39;The following waterbodies result in invalid polygons when intersected with the domain:&#39;)</span>
            <span class="c1">#    for c in comids:</span>
            <span class="c1">#        print(c)</span>
            <span class="n">wbgeoms</span> <span class="o">=</span> <span class="p">[</span><span class="n">Polygon</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">exterior</span><span class="p">)</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                       <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">wb</span><span class="o">.</span><span class="n">geometry</span><span class="p">]</span>
            <span class="n">wbgeoms</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ff</span><span class="p">)</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">wbgeoms</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wb</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wbgeoms</span>
            <span class="c1"># for multipolygons, retain largest part</span>
            <span class="n">geoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wb</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">values</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">geoms</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;MultiPolygon&#39;</span><span class="p">:</span>
                    <span class="n">geoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">geoms</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">area</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">geoms</span><span class="p">])][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wb</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">geoms</span>

        <span class="c1"># for now, write out preprocessed data to maintain structure with arcpy</span>
        <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fl&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">df</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">EmptyDataFrame</span><span class="p">()</span>

        <span class="n">gisutils</span><span class="o">.</span><span class="n">df2shp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">flowlines_clipped</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
        <span class="n">gisutils</span><span class="o">.</span><span class="n">df2shp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">waterbodies_clipped</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">making donut polygon of farfield (with routed area removed)...&#39;</span><span class="p">)</span>
        <span class="n">ffdonut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ff</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">fiona</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">routed_area</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">fiona</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">farfield_mp</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">src</span><span class="o">.</span><span class="n">meta</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">((</span><span class="s1">&#39;writing </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">farfield_mp</span><span class="p">)))</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">src</span><span class="p">))</span>
                <span class="n">f</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">(</span><span class="n">ffdonut</span><span class="p">)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">routed_area</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">routed_area</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nearfield</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">making donut polygon of routed area (with nearfield area removed)...&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="o">.</span><span class="n">within</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Nearfield area must be within routed area!&#39;</span><span class="p">)</span>

            <span class="n">donut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">fiona</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nearfield</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">fiona</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">routed_mp</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">src</span><span class="o">.</span><span class="n">meta</span><span class="p">)</span> <span class="k">as</span> <span class="n">output</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">((</span><span class="s1">&#39;writing </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">routed_mp</span><span class="p">)))</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">src</span><span class="p">))</span>
                    <span class="n">f</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">(</span><span class="n">donut</span><span class="p">)</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="c1"># drop waterbodies that aren&#39;t lakes bigger than min size</span>
        <span class="n">min_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">min_nearfield_wb_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_waterbody_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_farfield_wb_size</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wb</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">wb</span><span class="o">.</span><span class="n">FTYPE</span> <span class="o">==</span> <span class="s1">&#39;LakePond&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wb</span><span class="o">.</span><span class="n">AREASQKM</span> <span class="o">&gt;</span> <span class="n">min_size</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">getting elevations for waterbodies not in the stream network&#39;</span><span class="p">)</span>
        <span class="n">isolated_wb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wb</span>
        <span class="n">isolated_wb_comids</span> <span class="o">=</span> <span class="n">isolated_wb</span><span class="o">.</span><span class="n">COMID</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wb_centroids_w_elevations</span><span class="p">):</span>
            <span class="c1"># get elevations for all waterbodies for the time being.</span>
            <span class="c1"># otherwise waterbodies associated with first-order streams may be dropped from farfield,</span>
            <span class="c1"># but still waterbodies list, causing a key error in the lakes setup</span>
            <span class="c1"># these lakes probably should be left in the farfield unless they are explicitly not wanted</span>
            <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            # (the centroids of some lakes might not be in the lake itself)</span>
<span class="sd">            wb_points = [wb.centroid if wb.centroid.within(wb)</span>
<span class="sd">                         else _get_random_point_in_polygon(wb)</span>
<span class="sd">                         for wb in isolated_wb.geometry.tolist()]</span>
<span class="sd">            # reproject the representative points into lat lon</span>
<span class="sd">            wb_points_ll = reproject(wb_points, self.crs_str, &quot;+init=epsg:4269&quot;)</span>
<span class="sd">            wb_elevations = get_elevations_from_epqs(wb_points_ll, units=self.ComputationalUnits)</span>

<span class="sd">            # add in elevations from waterbodies in stream network</span>

<span class="sd">            wb_points_df = pd.DataFrame({&#39;COMID&#39;: isolated_wb_comids,</span>
<span class="sd">                                         self.elevs_field: wb_elevations,</span>
<span class="sd">                                         &#39;geometry&#39;: wb_points})</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="n">wb_points_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_wb_elevations</span><span class="p">(</span><span class="n">isolated_wb</span><span class="p">)</span>
            <span class="n">gisutils</span><span class="o">.</span><span class="n">df2shp</span><span class="p">(</span><span class="n">wb_points_df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wb_centroids_w_elevations</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">reading elevations from </span><span class="si">{}</span><span class="s1">...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wb_centroids_w_elevations</span><span class="p">))</span>
            <span class="n">wb_points_df</span> <span class="o">=</span> <span class="n">gisutils</span><span class="o">.</span><span class="n">shp2df</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wb_centroids_w_elevations</span><span class="p">)</span>
            <span class="n">toget</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">isolated_wb_comids</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">wb_points_df</span><span class="o">.</span><span class="n">COMID</span><span class="o">.</span><span class="n">tolist</span><span class="p">()))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">toget</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">isolated_wb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wb</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">wb</span><span class="o">.</span><span class="n">COMID</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">toget</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">wb_points_df2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_wb_elevations</span><span class="p">(</span><span class="n">isolated_wb</span><span class="p">)</span>
                <span class="n">wb_points_df</span> <span class="o">=</span> <span class="n">wb_points_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wb_points_df2</span><span class="p">)</span>
                <span class="n">gisutils</span><span class="o">.</span><span class="n">df2shp</span><span class="p">(</span><span class="n">wb_points_df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wb_centroids_w_elevations</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

        <span class="c1"># open error reporting file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error_reporting</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">efp</span><span class="p">:</span>
            <span class="n">efp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Preprocessing...</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Assembling input...&#39;</span><span class="p">)</span>
        <span class="c1"># read linework shapefile into pandas dataframe</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">gisutils</span><span class="o">.</span><span class="n">shp2df</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flowlines_clipped</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s1">&#39;COMID&#39;</span><span class="p">,</span> <span class="n">index_dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dtype</span><span class="p">)</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="s1">&#39;COMID&#39;</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">cc</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flowlines_cols</span><span class="p">]],</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># might want to consider enforcing integer index here if strings cause problems</span>
        <span class="c1">#clipto = df.index.tolist()</span>
        <span class="n">elevs</span> <span class="o">=</span> <span class="n">gisutils</span><span class="o">.</span><span class="n">shp2df</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elevslope</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s1">&#39;COMID&#39;</span><span class="p">,</span> <span class="n">index_dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dtype</span><span class="p">)</span>  <span class="c1">#, clipto=clipto)</span>
        <span class="n">elevs</span> <span class="o">=</span> <span class="n">elevs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">elevs</span><span class="o">.</span><span class="n">COMID</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>
        <span class="n">pfvaa</span> <span class="o">=</span> <span class="n">gisutils</span><span class="o">.</span><span class="n">shp2df</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PlusFlowVAA</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s1">&#39;COMID&#39;</span><span class="p">,</span> <span class="n">index_dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dtype</span><span class="p">)</span>  <span class="c1">#, clipto=clipto)</span>
        <span class="n">pfvaa</span> <span class="o">=</span> <span class="n">pfvaa</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pfvaa</span><span class="o">.</span><span class="n">ComID</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>
        <span class="n">wbs</span> <span class="o">=</span> <span class="n">gisutils</span><span class="o">.</span><span class="n">shp2df</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">waterbodies_clipped</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s1">&#39;COMID&#39;</span><span class="p">,</span> <span class="n">index_dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dtype</span><span class="p">)</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="s1">&#39;COMID&#39;</span><span class="p">)</span>
        <span class="n">wbs</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">wbs</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">cc</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">wb_cols</span><span class="p">]],</span>
                 <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_enforce_dtypes</span><span class="p">(</span><span class="n">wbs</span><span class="p">)</span>

        <span class="c1"># check for MultiLineStrings / MultiPolygons and drop them (these are features that were fragmented by the boundaries)</span>
        <span class="n">mls</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="s1">&#39;Multi&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">mls</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mps</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">wbs</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="s1">&#39;Multi&#39;</span> <span class="ow">in</span> <span class="n">wbs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="p">]</span>
        <span class="n">wbs</span> <span class="o">=</span> <span class="n">wbs</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">mps</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># join NHD tables to lines</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">elevs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">elevslope_cols</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="n">lsuffix</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pfvaa</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pfvaa_cols</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="n">lsuffix</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_enforce_dtypes</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="c1"># read in nearfield and farfield boundaries</span>
        <span class="n">nf</span> <span class="o">=</span> <span class="n">gisutils</span><span class="o">.</span><span class="n">shp2df</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nearfield</span><span class="p">)</span>
        <span class="n">nfg</span> <span class="o">=</span> <span class="n">nf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span>  <span class="c1"># polygon representing nearfield</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">routed_area</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">routed_area</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nearfield</span><span class="p">:</span>
            <span class="n">ra</span> <span class="o">=</span> <span class="n">gisutils</span><span class="o">.</span><span class="n">shp2df</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">routed_mp</span><span class="p">)</span>
            <span class="n">rag</span> <span class="o">=</span> <span class="n">ra</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rag</span> <span class="o">=</span> <span class="n">nfg</span>
            <span class="n">nfg</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">()</span> <span class="c1"># no nearfield specified</span>
        <span class="n">ff</span> <span class="o">=</span> <span class="n">gisutils</span><span class="o">.</span><span class="n">shp2df</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">farfield_mp</span><span class="p">)</span>
        <span class="n">ffg</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span>  <span class="c1"># shapely geometry object for farfield (polygon with interior ring for nearfield)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">identifying farfield and nearfield LinesinkData...&#39;</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;farfield&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">ffg</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">rag</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">geometry</span><span class="p">]</span>
        <span class="n">wbs</span><span class="p">[</span><span class="s1">&#39;farfield&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">poly</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">ffg</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">poly</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">rag</span><span class="p">)</span> <span class="k">for</span> <span class="n">poly</span> <span class="ow">in</span> <span class="n">wbs</span><span class="o">.</span><span class="n">geometry</span><span class="p">]</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;routed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">rag</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">geometry</span><span class="p">]</span>
        <span class="n">wbs</span><span class="p">[</span><span class="s1">&#39;routed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">poly</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">rag</span><span class="p">)</span> <span class="k">for</span> <span class="n">poly</span> <span class="ow">in</span> <span class="n">wbs</span><span class="o">.</span><span class="n">geometry</span><span class="p">]</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;nearfield&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">nfg</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">geometry</span><span class="p">]</span>
        <span class="n">wbs</span><span class="p">[</span><span class="s1">&#39;nearfield&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">poly</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">nfg</span><span class="p">)</span> <span class="k">for</span> <span class="n">poly</span> <span class="ow">in</span> <span class="n">wbs</span><span class="o">.</span><span class="n">geometry</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">asum_thresh_ra</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">removing streams in routed area with arbolate sums &lt; </span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">asum_thresh_ra</span><span class="p">))</span>
            <span class="c1"># retain all streams in the farfield or in the routed area with arbolate sum &gt; threshold</span>
            <span class="n">criteria</span> <span class="o">=</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">routed</span><span class="o">.</span><span class="n">values</span> <span class="o">|</span> <span class="n">df</span><span class="o">.</span><span class="n">routed</span><span class="o">.</span><span class="n">values</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">ArbolateSu</span><span class="o">.</span><span class="n">values</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">asum_thresh_ra</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">criteria</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">asum_thresh_nf</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">removing streams in nearfield with arbolate sums &lt; </span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">asum_thresh_nf</span><span class="p">))</span>
            <span class="n">criteria</span> <span class="o">=</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">nearfield</span><span class="o">.</span><span class="n">values</span> <span class="o">|</span> <span class="n">df</span><span class="o">.</span><span class="n">nearfield</span><span class="o">.</span><span class="n">values</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">ArbolateSu</span><span class="o">.</span><span class="n">values</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">asum_thresh_nf</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">criteria</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">asum_thresh_ff</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">removing streams in farfield with arbolate sums &lt; </span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">asum_thresh_ff</span><span class="p">))</span>
            <span class="n">criteria</span> <span class="o">=</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">farfield</span><span class="o">.</span><span class="n">values</span> <span class="o">|</span> <span class="n">df</span><span class="o">.</span><span class="n">farfield</span><span class="o">.</span><span class="n">values</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">ArbolateSu</span><span class="o">.</span><span class="n">values</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">asum_thresh_ff</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">criteria</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_nearfield_order</span> <span class="o">&gt;</span> <span class="mf">1.</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;removing nearfield streams lower than </span><span class="si">{}</span><span class="s1"> order...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_nearfield_order</span><span class="p">))</span>
            <span class="c1"># retain all streams in the nearfield of order &gt; min_farfield_order</span>
            <span class="n">criteria</span> <span class="o">=</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">nearfield</span><span class="o">.</span><span class="n">values</span> <span class="o">|</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">nearfield</span><span class="o">.</span><span class="n">values</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">StreamOrde</span><span class="o">.</span><span class="n">values</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_nearfield_order</span><span class="p">))</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">criteria</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_routed_area_order</span> <span class="o">&gt;</span> <span class="mf">1.</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;removing streams in the routed area of lower than </span><span class="si">{}</span><span class="s1"> order...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_routed_area_order</span><span class="p">))</span>
            <span class="c1"># retain all streams in the nearfield of order &gt; min_farfield_order</span>
            <span class="n">routed</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">routed</span><span class="o">.</span><span class="n">values</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">nearfield</span><span class="o">.</span><span class="n">values</span>
            <span class="n">criteria</span> <span class="o">=</span> <span class="o">~</span><span class="n">routed</span> <span class="o">|</span> <span class="p">(</span><span class="n">routed</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">StreamOrde</span><span class="o">.</span><span class="n">values</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_routed_area_order</span><span class="p">))</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">criteria</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_farfield_order</span> <span class="o">&gt;</span> <span class="mf">1.</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;removing farfield streams lower than </span><span class="si">{}</span><span class="s1"> order...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_farfield_order</span><span class="p">))</span>
            <span class="c1"># retain all streams in the nearfield or in the farfield and of order &gt; min_farfield_order</span>
            <span class="n">criteria</span> <span class="o">=</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">farfield</span><span class="o">.</span><span class="n">values</span> <span class="o">|</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">farfield</span><span class="o">.</span><span class="n">values</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">StreamOrde</span><span class="o">.</span><span class="n">values</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_farfield_order</span><span class="p">))</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">criteria</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">farfield_retain</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">farfield</span><span class="o">.</span><span class="n">values</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">FCODE</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">fcodes</span><span class="p">[</span><span class="s1">&#39;Intermittent&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="c1"># drop intermittent streams from farfield</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_intermittent</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;removing intermittent streams from routed area outside of nearfield...&#39;</span><span class="p">)</span>
            <span class="c1"># retain all streams in the nearfield or in the farfield and of order &gt; min_farfield_order</span>
            <span class="n">farfield_retain</span> <span class="o">=</span> <span class="n">farfield_retain</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">routed</span><span class="o">.</span><span class="n">values</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">nearfield</span><span class="o">.</span><span class="n">values</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">FCODE</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">fcodes</span><span class="p">[</span><span class="s1">&#39;Intermittent&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">farfield_retain</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;dropping waterbodies from routed area that are not lakes larger than </span><span class="si">{}</span><span class="s1">...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_waterbody_size</span><span class="p">))</span>
        <span class="n">nearfield_wbs</span> <span class="o">=</span> <span class="n">wbs</span><span class="o">.</span><span class="n">nearfield</span><span class="o">.</span><span class="n">values</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">wbs</span><span class="o">.</span><span class="n">AREASQKM</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_nearfield_wb_size</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">wbs</span><span class="o">.</span><span class="n">FTYPE</span> <span class="o">==</span> <span class="s1">&#39;LakePond&#39;</span><span class="p">)</span>
        <span class="n">routedarea_wbs</span> <span class="o">=</span> <span class="n">wbs</span><span class="o">.</span><span class="n">routed</span><span class="o">.</span><span class="n">values</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">wbs</span><span class="o">.</span><span class="n">AREASQKM</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_waterbody_size</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">wbs</span><span class="o">.</span><span class="n">FTYPE</span> <span class="o">==</span> <span class="s1">&#39;LakePond&#39;</span><span class="p">)</span>
        <span class="n">farfield_wbs</span> <span class="o">=</span> <span class="n">wbs</span><span class="o">.</span><span class="n">farfield</span><span class="o">.</span><span class="n">values</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">wbs</span><span class="o">.</span><span class="n">AREASQKM</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_farfield_wb_size</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">wbs</span><span class="o">.</span><span class="n">FTYPE</span> <span class="o">==</span> <span class="s1">&#39;LakePond&#39;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;dropping waterbodies from nearfield that are not lakes larger than </span><span class="si">{}</span><span class="s1">...</span><span class="se">\n</span><span class="s1">&#39;</span>
              <span class="s1">&#39;dropping waterbodies from farfield that are not lakes larger than </span><span class="si">{}</span><span class="s1">...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_waterbody_size</span><span class="p">,</span>
                                                                                               <span class="bp">self</span><span class="o">.</span><span class="n">min_farfield_wb_size</span><span class="p">))</span>
        <span class="n">wbs</span> <span class="o">=</span> <span class="n">wbs</span><span class="p">[</span><span class="n">nearfield_wbs</span> <span class="o">|</span> <span class="n">routedarea_wbs</span> <span class="o">|</span> <span class="n">farfield_wbs</span><span class="p">]</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;merging waterbodies with coincident boundaries...&#39;</span><span class="p">)</span>
        <span class="n">dropped</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">wb_comid</span> <span class="ow">in</span> <span class="n">wbs</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>

            <span class="c1"># skipped waterbodies that have already been merged</span>
            <span class="k">if</span> <span class="n">wb_comid</span> <span class="ow">in</span> <span class="n">dropped</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">wb_geometry</span> <span class="o">=</span> <span class="n">wbs</span><span class="o">.</span><span class="n">geometry</span><span class="p">[</span><span class="n">wb_comid</span><span class="p">]</span>
            <span class="n">overlapping</span> <span class="o">=</span> <span class="n">wbs</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">wb_geometry</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">wbs</span><span class="o">.</span><span class="n">geometry</span><span class="p">]]</span>
            <span class="n">basering_comid</span> <span class="o">=</span> <span class="n">overlapping</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;FTYPE&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># sort to prioritize features with names</span>

            <span class="c1"># two or more shapes in overlapping signifies a coincident boundary</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">overlapping</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">merged</span> <span class="o">=</span> <span class="n">unary_union</span><span class="p">([</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">overlapping</span><span class="o">.</span><span class="n">geometry</span><span class="p">])</span>
                <span class="c1"># multipolygons will result if the two polygons only have a single point in common</span>
                <span class="k">if</span> <span class="n">merged</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;MultiPolygon&#39;</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">wbs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">basering_comid</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged</span>

                <span class="n">todrop</span> <span class="o">=</span> <span class="p">[</span><span class="n">wbc</span> <span class="k">for</span> <span class="n">wbc</span> <span class="ow">in</span> <span class="n">overlapping</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="n">wbc</span> <span class="o">!=</span> <span class="n">basering_comid</span><span class="p">]</span>
                <span class="n">dropped</span> <span class="o">+=</span> <span class="n">todrop</span>
                <span class="n">wbs</span> <span class="o">=</span> <span class="n">wbs</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">todrop</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># only keep merged feature; drop others from index</span>

                <span class="c1"># replace references to dropped waterbody in lines</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">WBAREACOMI</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">todrop</span><span class="p">),</span> <span class="s1">&#39;WBAREACOMI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">basering_comid</span>

        <span class="c1"># swap out polygons in lake geometry column with the linear rings that make up their exteriors</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;converting lake exterior polygons to lines...&#39;</span><span class="p">)</span>
        <span class="n">wbs</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">LineString</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">exterior</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">wbs</span><span class="o">.</span><span class="n">geometry</span><span class="p">]</span>
        <span class="n">wbs</span><span class="p">[</span><span class="s1">&#39;waterbody&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">True</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">wbs</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>  <span class="c1"># boolean variable indicate whether feature is waterbody</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;merging flowline and waterbody datasets...&#39;</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;waterbody&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wbs</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">COMID</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        if self.clip_farfield:</span>
<span class="sd">            print(&#39;clipping farfield features...&#39;)</span>
<span class="sd">            df.loc[df.farfield.values, &#39;geometry&#39;] = [g.intersection(ffg)</span>
<span class="sd">                                                      for g in df.geometry[df.farfield.values]]</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Done with preprocessing.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="n">gisutils</span><span class="o">.</span><span class="n">df2shp</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocessed_lines</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span></div>

<div class="viewcode-block" id="LinesinkData.simplify_lines"><a class="viewcode-back" href="../../api/index.html#lsmaker.lsmaker.LinesinkData.simplify_lines">[docs]</a>    <span class="k">def</span> <span class="nf">simplify_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nearfield_tolerance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">routed_area_tolerance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">farfield_tolerance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">nearfield_refinement</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;Reduces the number of vertices in the GIS linework representing streams and lakes,</span>
<span class="sd">        to within specified tolerances. The tolerance values represent the maximum distance</span>
<span class="sd">        in the coordinate system units that the simplified feature can deviate from the original feature.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nearfield_tolerance : float</span>
<span class="sd">            Tolerance for the area representing the model nearfield</span>
<span class="sd">        farfield_tolerance : float</span>
<span class="sd">            Tolerance for the area representing the model farfield</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        df : DataFrame</span>
<span class="sd">            A copy of the df attribute with a &#39;ls_geom&#39; column of simplified geometries, and</span>
<span class="sd">            a &#39;ls_coords&#39; column containing lists of coordinate tuples defining each simplified line.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;df&#39;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No dataframe attribute for LinesinkData instance. Run preprocess first.&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">nearfield_tolerance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nearfield_tolerance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nearfield_tolerance</span>
            <span class="n">routed_area_tolerance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">routed_area_tolerance</span>
            <span class="n">farfield_tolerance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">farfield_tolerance</span>

        <span class="c1">#if isinstance(self.df.farfield.iloc[0], str):</span>
        <span class="c1">#    self.df.loc[:, &#39;farfield&#39;] = [True if f.lower() == &#39;true&#39; else False for f in self.df.farfield]</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;simplifying NHD linework geometries...&#39;</span><span class="p">)</span>
        <span class="c1"># simplify line and waterbody geometries</span>
        <span class="c1">#(see http://toblerity.org/shapely/manual.html)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;farfield&#39;</span><span class="p">,</span> <span class="s1">&#39;routed&#39;</span><span class="p">,</span> <span class="s1">&#39;nearfield&#39;</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">ls_geom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">LineString</span><span class="p">()]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
        <span class="n">tols</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;nf&#39;</span><span class="p">:</span> <span class="n">nearfield_tolerance</span><span class="p">,</span>
                <span class="s1">&#39;ra&#39;</span><span class="p">:</span> <span class="n">routed_area_tolerance</span><span class="p">,</span>
                <span class="s1">&#39;ff&#39;</span><span class="p">:</span> <span class="n">farfield_tolerance</span><span class="p">}</span>
        <span class="n">simplification</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;nf&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">nearfield</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                          <span class="s1">&#39;ra&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">routed</span><span class="o">.</span><span class="n">values</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">nearfield</span><span class="o">.</span><span class="n">values</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">farfield</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                          <span class="s1">&#39;ff&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">farfield</span><span class="o">.</span><span class="n">values</span><span class="p">}</span>
        <span class="p">[</span><span class="n">simplification</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">tols</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">within</span> <span class="ow">in</span> <span class="n">simplification</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># simplify the LinesinkData in the domain; add simplified geometries to global geometry column</span>
            <span class="c1"># assign geometries to numpy array first and then to df (had trouble assigning with pandas)</span>
            <span class="n">ls_geom</span><span class="p">[</span><span class="n">within</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">tols</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">within</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span>

        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ls_geom&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ls_geom</span>

        <span class="c1"># add columns for additional nearfield refinement areas</span>
        <span class="k">for</span> <span class="n">shp</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">nearfield_refinement</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">shp</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">refinement_areas</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">refinement_areas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shp</span><span class="p">)</span>
            <span class="n">area_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">shp</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
            <span class="k">with</span> <span class="n">fiona</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">shp</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
                <span class="n">poly</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">src</span><span class="p">))[</span><span class="s1">&#39;geometry&#39;</span><span class="p">])</span>
            <span class="c1">#poly = shape(fiona.open(shp).next()[&#39;geometry&#39;])</span>
            <span class="n">df</span><span class="p">[</span><span class="n">area_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">geometry</span><span class="p">]</span>

        <span class="c1"># add column of lists, containing linesink coordinates</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ls_coords&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">ls_geom</span><span class="p">]</span>

        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">ls_coords</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># shouldn&#39;t be an empty coordinates</span>

        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="LinesinkData.prototype"><a class="viewcode-back" href="../../api/index.html#lsmaker.lsmaker.LinesinkData.prototype">[docs]</a>    <span class="k">def</span> <span class="nf">prototype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nftol</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">500</span><span class="p">],</span> <span class="n">fftol</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Function to compare multiple simplification distance tolerance values for the model nearfield.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        nftol : list</span>
<span class="sd">            Contains the tolerance values to be compared.</span>
<span class="sd">        fftol : numeric</span>
<span class="sd">            Single tolerance value to be used for the farfield in all comparisons.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        A new directory called &quot;prototypes&quot; is made</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="s1">&#39;prototypes&#39;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s1">&#39;prototypes&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fftol</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fftol</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">fftol</span> <span class="o">=</span> <span class="p">[</span><span class="n">fftol</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">nftol</span><span class="p">)</span>

        <span class="n">nlines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nftol</span><span class="p">):</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simplify_lines</span><span class="p">(</span><span class="n">nearfield_tolerance</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span> <span class="n">farfield_tolerance</span><span class="o">=</span><span class="n">fftol</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

            <span class="c1"># count the number of lines with distance tolerance</span>
            <span class="n">nlines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">ls_coords</span><span class="p">]))</span>

            <span class="c1"># make a shapefile of the simplified lines with nearfield_tol=tol</span>
            <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;ls_coords&#39;</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">outshp</span> <span class="o">=</span> <span class="s1">&#39;prototypes/&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">outfile_basename</span> <span class="o">+</span> <span class="s1">&#39;_dis_tol_</span><span class="si">{}</span><span class="s1">.shp&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tol</span><span class="p">)</span>
            <span class="n">gisutils</span><span class="o">.</span><span class="n">df2shp</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">outshp</span><span class="p">,</span> <span class="n">geo_column</span><span class="o">=</span><span class="s1">&#39;ls_geom&#39;</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">nftol</span><span class="p">,</span> <span class="n">nlines</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Distance tolerance&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Number of lines&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outfile_basename</span> <span class="o">+</span> <span class="s1">&#39;tol_vs_nlines.pdf&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="LinesinkData.adjust_zero_gradient"><a class="viewcode-back" href="../../api/index.html#lsmaker.lsmaker.LinesinkData.adjust_zero_gradient">[docs]</a>    <span class="k">def</span> <span class="nf">adjust_zero_gradient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">increment</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>

        <span class="n">dg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dg</span>
        <span class="n">dg</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span>
        <span class="n">comids0</span> <span class="o">=</span> <span class="n">dg</span><span class="o">.</span><span class="n">check4zero_gradient</span><span class="p">(</span><span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">comids0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">confluences</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">map_confluences</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outsegs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">map_outsegs</span><span class="p">()</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error_reporting</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">efp</span><span class="p">:</span>
                <span class="n">efp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">zero-gradient adjustments:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">efp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;comid, old_elevmax, old_elevmin, new_elevmax, new_elevmin, downcomid</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;adjusting elevations for comids with zero-gradient...&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">comid</span> <span class="ow">in</span> <span class="n">comids0</span><span class="p">:</span>

                    <span class="n">outsegs</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outsegs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">comid</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">outsegs</span><span class="p">):</span>

                        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">outsegs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">oo</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">oo</span> <span class="o">=</span> <span class="n">outsegs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

                        <span class="n">minElev</span><span class="p">,</span> <span class="n">maxElev</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">o</span><span class="p">,</span> <span class="s1">&#39;minElev&#39;</span><span class="p">],</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">o</span><span class="p">,</span> <span class="s1">&#39;maxElev&#39;</span><span class="p">]</span>
                        <span class="c1"># test if current segment has flat or negative gradient</span>
                        <span class="k">if</span> <span class="n">minElev</span> <span class="o">&gt;=</span> <span class="n">maxElev</span><span class="p">:</span>
                            <span class="n">minElev</span> <span class="o">=</span> <span class="n">maxElev</span> <span class="o">-</span> <span class="n">increment</span>
                            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">o</span><span class="p">,</span> <span class="s1">&#39;minElev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">minElev</span>
                            <span class="n">efp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">, </span><span class="si">{:.2f}</span><span class="s1">, </span><span class="si">{:.2f}</span><span class="s1">, </span><span class="si">{:.2f}</span><span class="s1">, </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">maxElev</span><span class="p">,</span>
                                                                                    <span class="n">minElev</span> <span class="o">+</span> <span class="n">increment</span><span class="p">,</span>
                                                                                    <span class="n">maxElev</span><span class="p">,</span>
                                                                                    <span class="n">minElev</span><span class="p">,</span> <span class="n">oo</span><span class="p">))</span>
                            <span class="c1"># test if next segment is now higher</span>
                            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">oo</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">oo</span><span class="p">,</span> <span class="s1">&#39;maxElev&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">minElev</span><span class="p">:</span>
                                <span class="n">efp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">, </span><span class="si">{:.2f}</span><span class="s1">, </span><span class="si">{:.2f}</span><span class="s1">, </span><span class="si">{:.2f}</span><span class="s1">, </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outsegs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
                                                                                        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">outsegs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;maxElev&#39;</span><span class="p">],</span>
                                                                                        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">outsegs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;minElev&#39;</span><span class="p">],</span>
                                                                                        <span class="n">minElev</span><span class="p">,</span>
                                                                                        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">outsegs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;minElev&#39;</span><span class="p">],</span>
                                                                                        <span class="n">oo</span><span class="p">))</span>
                                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">oo</span><span class="p">,</span> <span class="s1">&#39;maxElev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">minElev</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">break</span>

                            <span class="c1"># check again for zero-gradient lines</span>
                <span class="n">dg</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span>
                <span class="n">comids0</span> <span class="o">=</span> <span class="n">dg</span><span class="o">.</span><span class="n">check4zero_gradient</span><span class="p">(</span><span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">comids0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">comids0</span><span class="p">:</span>
                        <span class="n">efp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Warning!, the following comids had zero gradients:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comids0</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;routing for these was turned off. Elevations must be fixed manually.</span><span class="se">\n</span><span class="s2">&quot;</span> \
                        <span class="s2">&quot;See </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error_reporting</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="LinesinkData.drop_crossing_lines"><a class="viewcode-back" href="../../api/index.html#lsmaker.lsmaker.LinesinkData.drop_crossing_lines">[docs]</a>    <span class="k">def</span> <span class="nf">drop_crossing_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>

        <span class="n">dg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dg</span>
        <span class="n">crosses</span> <span class="o">=</span> <span class="n">dg</span><span class="o">.</span><span class="n">check4crossing_lines</span><span class="p">()</span></div>

<div class="viewcode-block" id="LinesinkData.drop_duplicates"><a class="viewcode-back" href="../../api/index.html#lsmaker.lsmaker.LinesinkData.drop_duplicates">[docs]</a>    <span class="k">def</span> <span class="nf">drop_duplicates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="c1"># loops or braids in NHD linework can result in duplicate lines after simplification</span>
        <span class="c1"># create column of line coordinates converted to strings</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ls_coords_str&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">coords</span><span class="p">))</span> <span class="k">for</span> <span class="n">coords</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">ls_coords</span><span class="p">]</span>

        <span class="c1"># identify duplicates; make common set of up and down comids for duplicates</span>
        <span class="n">duplicates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="s1">&#39;ls_coords_str&#39;</span><span class="p">),</span> <span class="s1">&#39;ls_coords_str&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">dup</span> <span class="ow">in</span> <span class="n">duplicates</span><span class="p">:</span>
            <span class="n">alld</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">ls_coords_str</span> <span class="o">==</span> <span class="n">dup</span><span class="p">]</span>
            <span class="n">upcomids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">dncomid</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">alld</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="n">upcomids</span> <span class="o">+=</span> <span class="n">r</span><span class="o">.</span><span class="n">upcomids</span>
                <span class="n">dncomid</span> <span class="o">+=</span> <span class="n">r</span><span class="o">.</span><span class="n">dncomid</span>

            <span class="n">upcomids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">upcomids</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">({</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">}))</span>
            <span class="n">dncomid</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">dncomid</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">({</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">}))</span>

            <span class="n">keep_comid</span> <span class="o">=</span> <span class="n">alld</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">keep_comid</span><span class="p">,</span> <span class="s1">&#39;upcomids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">upcomids</span>
            <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">keep_comid</span><span class="p">,</span> <span class="s1">&#39;dncomid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dncomid</span>
            <span class="c1">#df.set_value(keep_comid, &#39;upcomids&#39;, upcomids)</span>
            <span class="c1">#df.set_value(keep_comid, &#39;dncomid&#39;, dncomid)</span>
            <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">upcomids</span><span class="p">:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">u</span><span class="p">,</span> <span class="s1">&#39;dncomid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">keep_comid</span><span class="p">]</span>
                <span class="c1">#df.set_value(u, &#39;dncomid&#39;, [keep_comid])</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dncomid</span><span class="p">:</span>
                <span class="n">upids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="s1">&#39;upcomids&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">alld</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
                <span class="n">upids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">alld</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="s1">&#39;upcomids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">upids</span><span class="p">)</span>
                <span class="c1">#df.set_value(d, &#39;upcomids&#39;, list(upids))</span>
            <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">alld</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># drop the duplicates (this may cause problems if multiple braids are routed to)</span>
        <span class="c1">#df = df.drop_duplicates(&#39;ls_coords_str&#39;) # drop rows from dataframe containing duplicates</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;ls_coords_str&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="LinesinkData.setup_linesink_lakes"><a class="viewcode-back" href="../../api/index.html#lsmaker.lsmaker.LinesinkData.setup_linesink_lakes">[docs]</a>    <span class="k">def</span> <span class="nf">setup_linesink_lakes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>

        <span class="c1"># read in elevations for NHD waterbodies (from preprocessing routine; needed for isolated lakes)</span>
        <span class="n">wb_elevs</span> <span class="o">=</span> <span class="n">gisutils</span><span class="o">.</span><span class="n">shp2df</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wb_centroids_w_elevations</span><span class="p">,</span>
                                <span class="n">index</span><span class="o">=</span><span class="s1">&#39;COMID&#39;</span><span class="p">,</span> <span class="n">index_dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dtype</span><span class="p">)</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="s1">&#39;COMID&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_enforce_dtypes</span><span class="p">(</span><span class="n">wb_elevs</span><span class="p">)</span>
        <span class="n">wb_elevs</span> <span class="o">=</span> <span class="n">wb_elevs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">elevs_field</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEM_zmult</span>

        <span class="c1"># identify lines that represent lakes</span>
        <span class="c1"># get elevations, up/downcomids, and total lengths for those lines</span>
        <span class="c1"># assign attributes to lakes, then drop the lines</span>

        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;total_line_length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># field to store total shoreline length of lakes</span>
        <span class="k">for</span> <span class="n">wb_comid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">wblist</span><span class="p">:</span>

            <span class="n">lines</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;WBAREACOMI&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">wb_comid</span><span class="p">]</span>
            <span class="n">upcomids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">dncomids</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># isolated lakes have no overlapping lines and no routing</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">wb_comid</span><span class="p">,</span> <span class="s1">&#39;maxElev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wb_elevs</span><span class="p">[</span><span class="n">wb_comid</span><span class="p">]</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">wb_comid</span><span class="p">,</span> <span class="s1">&#39;minElev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wb_elevs</span><span class="p">[</span><span class="n">wb_comid</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.01</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">wb_comid</span><span class="p">,</span> <span class="s1">&#39;routing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">wb_comid</span><span class="p">,</span> <span class="s1">&#39;minElev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">lines</span><span class="o">.</span><span class="n">minElev</span><span class="p">)</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">wb_comid</span><span class="p">,</span> <span class="s1">&#39;maxElev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">lines</span><span class="o">.</span><span class="n">maxElev</span><span class="p">)</span>

                <span class="c1"># get upcomids and downcomid for lake,</span>
                <span class="c1"># by differencing all up/down comids for lines in lake, and comids in the lake</span>
                <span class="n">upcomids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">c</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lines</span><span class="o">.</span><span class="n">upcomids</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">l</span><span class="p">])</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">lines</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
                <span class="n">dncomids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">c</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lines</span><span class="o">.</span><span class="n">dncomid</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">l</span><span class="p">])</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">lines</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>

                <span class="c1"># .at sets an entry for a single row/column location in a DataFrame</span>
                <span class="c1"># (to avoid confusion over specifying a single row but supplying a sequence)</span>
                <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">wb_comid</span><span class="p">,</span> <span class="s1">&#39;upcomids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">upcomids</span>
                <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">wb_comid</span><span class="p">,</span> <span class="s1">&#39;dncomid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dncomids</span>
                <span class="c1">#df.set_value(wb_comid, &#39;upcomids&#39;, upcomids)</span>
                <span class="c1">#df.set_value(wb_comid, &#39;dncomid&#39;, dncomids)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="kc">True</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comid</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="kc">False</span> <span class="k">for</span> <span class="n">comid</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">upcomids</span><span class="p">])</span>
                    <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="kc">True</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comid</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="kc">False</span> <span class="k">for</span> <span class="n">comid</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">dncomid</span><span class="p">])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">j</span><span class="o">=</span><span class="mi">2</span>


                <span class="c1"># make the lake the down-comid for the upcomids of the lake</span>
                <span class="c1"># (instead of the lines that represented the lake in the flowlines dataset)</span>
                <span class="c1"># do the same for the down-comid of the lake</span>
                <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="p">[</span><span class="n">u</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">upcomids</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]:</span>  <span class="c1"># exclude outlets</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">u</span><span class="p">,</span> <span class="s1">&#39;dncomid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">wb_comid</span><span class="p">]</span>
                    <span class="c1">#df.set_value(u, &#39;dncomid&#39;, [wb_comid])</span>
                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dncomids</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]:</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="s1">&#39;upcomids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">wb_comid</span><span class="p">]</span>
                    <span class="c1">#df.set_value(d, &#39;upcomids&#39;, [wb_comid])</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="kc">True</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comid</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="kc">False</span> <span class="k">for</span> <span class="n">comid</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">upcomids</span><span class="p">])</span>
                    <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="kc">True</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comid</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="kc">False</span> <span class="k">for</span> <span class="n">comid</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">dncomid</span><span class="p">])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">j</span><span class="o">=</span><span class="mi">2</span>
                <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">                # update all up/dn comids in lines dataframe that reference the lines inside of the lakes</span>
<span class="sd">                # (replace those references with the comids for the lakes)</span>
<span class="sd">                for comid in lines.index:</span>
<span class="sd">                    if comid == 937070193:</span>
<span class="sd">                        j=2</span>

<span class="sd">                    # make the lake the down-comid for the upcomids of the lake</span>
<span class="sd">                    # (instead of the lines that represented the lake in the flowlines dataset)</span>
<span class="sd">                    df.loc[upcomids, &#39;dncomid&#39;] = [wb_comid]</span>
<span class="sd">                    df.loc[dncomids, &#39;upcomids&#39;] = [wb_comid]</span>
<span class="sd">                    df.loc[df.FTYPE != &#39;LakePond&#39;, &#39;dncomid&#39;] = [[wb_comid if v == comid else v for v in l] for l in df[df.FTYPE != &#39;LakePond&#39;].dncomid]</span>
<span class="sd">                    df.loc[df.FTYPE != &#39;LakePond&#39;, &#39;upcomids&#39;] = [[wb_comid if v == comid else v for v in l] for l in df[df.FTYPE != &#39;LakePond&#39;].upcomids]</span>
<span class="sd">                &#39;&#39;&#39;</span>
                <span class="c1"># get total length of lines representing lake (used later to estimate width)</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">wb_comid</span><span class="p">,</span> <span class="s1">&#39;total_line_length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">lines</span><span class="o">.</span><span class="n">LENGTHKM</span><span class="p">)</span>

                <span class="c1"># modifications to routed lakes</span>
                <span class="c1">#if df.loc[wb_comid, &#39;routing&#39;] == 1:</span>

                <span class="c1"># enforce gradient in routed lakes; update elevations in downstream comids</span>
                <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">wb_comid</span><span class="p">,</span> <span class="s1">&#39;minElev&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">wb_comid</span><span class="p">,</span> <span class="s1">&#39;maxElev&#39;</span><span class="p">]:</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">wb_comid</span><span class="p">,</span> <span class="s1">&#39;minElev&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.01</span>
                    <span class="n">dnids</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">wb_comid</span><span class="p">,</span> <span class="s1">&#39;dncomid&#39;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">dnid</span> <span class="ow">in</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dnids</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]:</span>
                        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dnid</span><span class="p">,</span> <span class="s1">&#39;maxElev&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.01</span>

            <span class="c1">#df[&#39;dncomid&#39;] = [[d] if not isinstance(d, list) else d for d in df.dncomid]</span>
            <span class="c1">#df[&#39;upcomids&#39;] = [[u] if not isinstance(u, list) else u for u in df.upcomids]</span>
            <span class="c1"># move begining/end coordinate of linear ring representing lake to outlet location (to ensure correct routing)</span>
            <span class="c1"># some routed lakes may not have an outlet</span>
            <span class="c1"># do this for both routed and unrouted (farfield) lakes, so that the outlet line won&#39;t cross the lake</span>
            <span class="c1"># (only tributaries are tested for crossing in step below)</span>
            <span class="n">lake_coords</span> <span class="o">=</span> <span class="n">uniquelist</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">wb_comid</span><span class="p">,</span> <span class="s1">&#39;ls_coords&#39;</span><span class="p">])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">wb_comid</span><span class="p">,</span> <span class="s1">&#39;dncomid&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">dncomids</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">outlet_coords</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">wb_comid</span><span class="p">,</span> <span class="s1">&#39;dncomid&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;ls_coords&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">closest_ind</span> <span class="o">=</span> <span class="n">closest_vertex_ind</span><span class="p">(</span><span class="n">outlet_coords</span><span class="p">,</span> <span class="n">lake_coords</span><span class="p">)</span>
                    <span class="n">lake_coords</span><span class="p">[</span><span class="n">closest_ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">outlet_coords</span>
                    <span class="n">next_ind</span> <span class="o">=</span> <span class="n">closest_ind</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">closest_ind</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lake_coords</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="c1"># for lakes without outlets, make the last coordinate the outlet so that it can be moved below</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">outlet_coords</span> <span class="o">=</span> <span class="n">lake_coords</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">next_ind</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">j</span><span class="o">=</span><span class="mi">2</span>

            <span class="n">inlet_coords</span> <span class="o">=</span> <span class="n">move_point_along_line</span><span class="p">(</span><span class="n">lake_coords</span><span class="p">[</span><span class="n">next_ind</span><span class="p">],</span> <span class="n">outlet_coords</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="n">new_coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">inlet_coords</span><span class="p">]</span> <span class="o">+</span> <span class="n">lake_coords</span><span class="p">[</span><span class="n">next_ind</span><span class="p">:]</span> <span class="o">+</span> <span class="n">lake_coords</span><span class="p">[:</span><span class="n">next_ind</span><span class="p">]</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">wb_comid</span><span class="p">,</span> <span class="s1">&#39;ls_coords&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">new_coords</span><span class="p">]</span>

            <span class="c1"># make sure inlets/outlets don&#39;t cross lines representing lake</span>
            <span class="n">wb_geom</span> <span class="o">=</span> <span class="n">LineString</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">wb_comid</span><span class="p">,</span> <span class="s1">&#39;ls_coords&#39;</span><span class="p">])</span>
            <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">upcomids</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">LineString</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s1">&#39;ls_coords&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">crosses</span><span class="p">(</span><span class="n">wb_geom</span><span class="p">)]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
                    <span class="n">ls_coords</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s1">&#39;ls_coords&#39;</span><span class="p">])</span>  <span class="c1"># want to copy, to avoid modifying df</span>
                    <span class="c1"># find the first intersection point with the lake</span>
                    <span class="c1"># (for some reason, two very similar coordinates will be occasionally be returned by intersection)</span>
                    <span class="n">intersection</span> <span class="o">=</span> <span class="n">LineString</span><span class="p">(</span><span class="n">ls_coords</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">wb_geom</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">intersection</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;MultiPoint&#39;</span><span class="p">:</span>
                        <span class="n">intersection_point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">intersection</span><span class="o">.</span><span class="n">geoms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                                       <span class="n">intersection</span><span class="o">.</span><span class="n">geoms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">intersection_point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">intersection</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">intersection</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]])</span>
                    <span class="c1"># sequentially drop last vertex from line until it no longer crosses the lake</span>
                    <span class="n">crossing</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">while</span> <span class="n">crossing</span><span class="p">:</span>
                        <span class="n">ls_coords</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ls_coords</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="c1"># need to test for intersection separately,</span>
                        <span class="c1"># in case len(ls_coords) == 1 (can&#39;t make a LineString)</span>
                        <span class="k">elif</span> <span class="n">LineString</span><span class="p">(</span><span class="n">ls_coords</span><span class="p">)</span><span class="o">.</span><span class="n">crosses</span><span class="p">(</span><span class="n">wb_geom</span><span class="p">):</span>
                            <span class="k">break</span>
                    <span class="c1"># append new end vertex on line that is close to, but not coincident with lake</span>
                    <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ls_coords</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">intersection_point</span>
                    <span class="c1"># make a new endpoint that is between the intersection and next to last</span>
                    <span class="n">new_endvert</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">intersection_point</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nearfield_tolerance</span><span class="p">))</span>
                    <span class="n">ls_coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_endvert</span><span class="p">)</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s1">&#39;ls_coords&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ls_coords</span>
                    <span class="c1">#df.set_value(c, &#39;ls_coords&#39;, ls_coords)</span>
            <span class="c1"># drop the lines representing the lake from the lines dataframe</span>
            <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">lines</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="LinesinkData.list_updown_comids"><a class="viewcode-back" href="../../api/index.html#lsmaker.lsmaker.LinesinkData.list_updown_comids">[docs]</a>    <span class="k">def</span> <span class="nf">list_updown_comids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>

        <span class="n">farfield</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">COMID</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">farfield</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="c1"># record up and downstream comids for lines</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="n">l</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">wblist</span> <span class="ow">and</span> <span class="n">l</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">farfield</span><span class="p">]</span>
        <span class="c1">#df[&#39;dncomid&#39;] = len(df)*[[]]</span>
        <span class="c1">#df[&#39;upcomids&#39;] = len(df)*[[]]</span>
        <span class="c1">#df.loc[lines, &#39;dncomid&#39;] = [list(df[df[&#39;Hydroseq&#39;] == df.loc[i, &#39;DnHydroseq&#39;]].index) for i in lines]</span>
        <span class="c1">#df.loc[lines, &#39;upcomids&#39;] = [list(df[df[&#39;DnHydroseq&#39;] == df.loc[i, &#39;Hydroseq&#39;]].index) for i in lines]</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;upcomids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[]]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;dncomid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[]]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">dncomid</span><span class="p">,</span> <span class="n">upcomids</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="c1"># set up/down comids that are not in the model domain to zero</span>
            <span class="n">dncomid</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">d</span> <span class="k">if</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span>
                            <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Hydroseq&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="s1">&#39;DnHydroseq&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span><span class="p">)])</span>
            <span class="n">upcomids</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">u</span> <span class="k">if</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span>
                             <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;DnHydroseq&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="s1">&#39;Hydroseq&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span><span class="p">)])</span>

        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">lines</span><span class="p">,</span> <span class="s1">&#39;upcomids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">upcomids</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">lines</span><span class="p">,</span> <span class="s1">&#39;dncomid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dncomid</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
        <span class="c1"># enforce list datatype (apparently pandas flattens lists of lists len()=1 on assignment</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;dncomid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="n">d</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">dncomid</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="LinesinkData.make_linesinks"><a class="viewcode-back" href="../../api/index.html#lsmaker.lsmaker.LinesinkData.make_linesinks">[docs]</a>    <span class="k">def</span> <span class="nf">make_linesinks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reuse_preprocessed_lines</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">shp</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error_reporting</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">efp</span><span class="p">:</span>
            <span class="n">efp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Making the lines...</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">shp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">shp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocessed_lines</span>

        <span class="k">if</span> <span class="n">reuse_preprocessed_lines</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">gisutils</span><span class="o">.</span><span class="n">shp2df</span><span class="p">(</span><span class="n">shp</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s1">&#39;COMID&#39;</span><span class="p">,</span>
                                    <span class="n">index_dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dtype</span><span class="p">,</span>
                                    <span class="n">true_values</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;True&#39;</span><span class="p">],</span>
                                    <span class="n">false_values</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;False&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_enforce_dtypes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># enforce integers columns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dtype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;COMID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">COMID</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dtype</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span>

        <span class="c1"># simplify the lines in the df (dataframe) attribute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lines_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simplify_lines</span><span class="p">()</span>

        <span class="c1"># add linesink geometries back in to dataframe</span>
        <span class="c1">#df[&#39;ls_geom&#39;] = self.lines_df[&#39;ls_geom&#39;]</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ls_coords&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines_df</span><span class="p">[</span><span class="s1">&#39;ls_coords&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wblist</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">waterbody</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dtype</span><span class="p">))</span><span class="o">.</span><span class="n">difference</span><span class="p">({</span><span class="mi">0</span><span class="p">})</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Assigning attributes for GFLOW input...&#39;</span><span class="p">)</span>

        <span class="c1"># routing</span>
        <span class="c1"># need to reformulate simplification so that &quot;routed&quot; means all routed LinesinkData,</span>
        <span class="c1"># not just those between the nearfield and farfield</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;routing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">routed</span><span class="o">.</span><span class="n">values</span> <span class="o">|</span> <span class="n">df</span><span class="o">.</span><span class="n">nearfield</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># linesink elevations (lakes won&#39;t be populated yet)</span>
        <span class="n">min_elev_col</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s1">&#39;minelev&#39;</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">max_elev_col</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s1">&#39;maxelev&#39;</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;minElev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">min_elev_col</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">zmult</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;maxElev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">max_elev_col</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">zmult</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;dStage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;maxElev&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;minElev&#39;</span><span class="p">]</span>

        <span class="c1"># list upstream and downstream comids</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_updown_comids</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="c1"># discard duplicate LinesinkData that result from braids in NHD and line simplification</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="c1"># method to represent lakes with LinesinkData</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_linesink_lakes</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">merging or splitting lines with only two vertices...&#39;</span><span class="p">)</span>
        <span class="c1"># find all routed comids with only 1 line; merge with neighboring comids</span>
        <span class="c1"># (GFLOW requires two lines for routed streams)</span>

        <span class="k">def</span> <span class="nf">bisect</span><span class="p">(</span><span class="n">coords</span><span class="p">):</span>
            <span class="c1"># add vertex to middle of single line segment</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
            <span class="n">mid</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">coords</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">new_coords</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="p">[</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mid</span><span class="p">,</span> <span class="n">coords</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]))</span>
            <span class="k">return</span> <span class="n">new_coords</span>

        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;nlines&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">coords</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">ls_coords</span><span class="p">)]</span>

        <span class="c1"># bisect lines that have only one segment, and are routed</span>
        <span class="n">ls_coords</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">ls_coords</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">singlesegment</span> <span class="o">=</span> <span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;nlines&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;routing&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">values</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ls_coords&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">bisect</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="k">if</span> <span class="n">singlesegment</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                           <span class="k">else</span> <span class="n">line</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ls_coords</span><span class="p">)]</span>

        <span class="c1"># fix LinesinkData where max and min elevations are the same</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjust_zero_gradient</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="c1"># end streams</span>
        <span class="c1"># evaluate whether downstream segment is in farfield</span>
        <span class="n">downstream_ff</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dff</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dncomid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;farfield&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">dff</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">downstream_ff</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dff</span><span class="p">)</span>

        <span class="c1"># set segments with downstream segment in farfield as End Segments</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;end_stream&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">*</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">downstream_ff</span><span class="p">,</span> <span class="s1">&#39;end_stream&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># set</span>

        <span class="c1"># widths for lines</span>
        <span class="n">arbolate_sum_col</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s1">&#39;arbolate&#39;</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">arbolate_sum_col</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">width_from_arboate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmbda</span><span class="p">))</span>

        <span class="c1"># widths for lakes</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;FTYPE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;LakePond&#39;</span><span class="p">):</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;FTYPE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;LakePond&#39;</span><span class="p">,</span> <span class="s1">&#39;width&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">lake_width</span><span class="p">)(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;FTYPE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;LakePond&#39;</span><span class="p">,</span> <span class="s1">&#39;AREASQKM&#39;</span><span class="p">],</span>
                                         <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;FTYPE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;LakePond&#39;</span><span class="p">,</span> <span class="s1">&#39;total_line_length&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmbda</span><span class="p">)</span>

        <span class="c1"># resistance</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;resistance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resistance</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;farfield&#39;</span><span class="p">],</span> <span class="s1">&#39;resistance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># depth</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_streambed_thickness</span>

        <span class="c1"># resistance parameter (scenario)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ScenResistance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ScenResistance</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;farfield&#39;</span><span class="p">],</span> <span class="s1">&#39;ScenResistance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;__NONE__&#39;</span>

        <span class="c1"># check box for &quot;include in Scenario&quot; in the GUI</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;chkScenario&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chkScenario</span>

        <span class="c1"># linesink location</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;FTYPE&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;LakePond&#39;</span><span class="p">,</span> <span class="s1">&#39;AutoSWIZC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Along stream centerline</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;FTYPE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;LakePond&#39;</span><span class="p">,</span> <span class="s1">&#39;AutoSWIZC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># Along surface water boundary</span>

        <span class="c1"># additional check to drop isolated lines</span>
        <span class="n">isolated</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">dncomid</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">upcomids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
                    <span class="ow">and</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">wblist</span><span class="p">]</span>
        <span class="c1">#df = df.drop(isolated, axis=0)</span>

        <span class="c1"># drop lines below minimum length that are not Lakes</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">farfield_length_threshold</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="n">criteria</span> <span class="o">=</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">farfield</span><span class="o">.</span><span class="n">values</span> <span class="o">|</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">FTYPE</span> <span class="o">==</span> <span class="s1">&#39;LakePond&#39;</span><span class="p">)</span> <span class="o">|</span>\
                       <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">farfield</span><span class="o">.</span><span class="n">values</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">LENGTHKM</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">farfield_length_threshold</span><span class="p">))</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">criteria</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">routed_area_length_threshold</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="n">criteria</span> <span class="o">=</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">routed</span><span class="o">.</span><span class="n">values</span> <span class="o">|</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">FTYPE</span> <span class="o">==</span> <span class="s1">&#39;LakePond&#39;</span><span class="p">)</span> <span class="o">|</span>\
                       <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">routed</span><span class="o">.</span><span class="n">values</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">LENGTHKM</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">routed_area_length_threshold</span><span class="p">))</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">criteria</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>


        <span class="c1"># names</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ls_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">*</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ls_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># compare number of line segments before and after</span>
        <span class="n">npoints_orig</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
        <span class="n">npoints_simp</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">ls_coords</span><span class="p">])</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">number of lines in original NHD linework: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">npoints_orig</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;number of simplified lines: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">npoints_simp</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">npoints_simp</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxlines</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning, the number of lines exceeds GFLOW&#39;s limit of </span><span class="si">{}</span><span class="s2">!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maxlines</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_by_HUC</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_lss_by_huc</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_lss</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.lss.xml&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outfile_basename</span><span class="p">))</span>

        <span class="c1"># run diagnostics on lines and report errors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_diagnostics</span><span class="p">()</span>

        <span class="c1"># write shapefile of results</span>
        <span class="c1"># convert lists in dn and upcomid columns to strings (for writing to shp)</span>
        <span class="c1"># clean up any dtypes that were altered from sloppy use of pandas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_enforce_dtypes</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_shapefile</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done!&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="LinesinkData.map_confluences"><a class="viewcode-back" href="../../api/index.html#lsmaker.lsmaker.LinesinkData.map_confluences">[docs]</a>    <span class="k">def</span> <span class="nf">map_confluences</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">upsegs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">upcomids</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">maxsegs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">uu</span><span class="p">)</span> <span class="k">for</span> <span class="n">uu</span> <span class="ow">in</span> <span class="n">u</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
                            <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">upsegs</span><span class="p">])</span>
        <span class="n">seglengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">upsegs</span><span class="p">])</span>
        <span class="c1"># setup dataframe of confluences</span>
        <span class="c1"># confluences are where segments have upsegs (no upsegs means the reach 1 is a headwater)</span>
        <span class="n">confluences</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">seglengths</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">maxsegs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;COMID&#39;</span><span class="p">,</span> <span class="s1">&#39;upcomids&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">confluences</span><span class="p">[</span><span class="s1">&#39;elev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">confluences</span><span class="p">)</span>
        <span class="n">nconfluences</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">confluences</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Mapping </span><span class="si">{}</span><span class="s1"> confluences and updating segment min/max elevations...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nconfluences</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">confluences</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>

            <span class="c1"># confluence elevation is the minimum of the ending segments minimums, starting segments maximums</span>
            <span class="n">endsmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">COMID</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">upcomids</span><span class="p">),</span> <span class="s1">&#39;minElev&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">startmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">COMID</span> <span class="o">==</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;maxElev&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">cfelev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">endsmin</span><span class="p">,</span> <span class="n">startmax</span><span class="p">])</span>
            <span class="n">confluences</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;elev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cfelev</span>

            <span class="n">upcomids</span> <span class="o">=</span> <span class="p">[</span><span class="n">u</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">upcomids</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">upcomids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">upcomids</span><span class="p">,</span> <span class="s1">&#39;minElev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cfelev</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;maxElev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cfelev</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">confluences</span> <span class="o">=</span> <span class="n">confluences</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;dStage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;maxElev&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;minElev&#39;</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done, see confluences attribute.&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="LinesinkData.run_diagnostics"><a class="viewcode-back" href="../../api/index.html#lsmaker.lsmaker.LinesinkData.run_diagnostics">[docs]</a>    <span class="k">def</span> <span class="nf">run_diagnostics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run the diagnostic suite on the LinesinkData instance.&quot;&quot;&quot;</span>
        <span class="n">dg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dg</span>
        <span class="n">dg</span><span class="o">.</span><span class="n">check_vertices</span><span class="p">()</span>
        <span class="n">dg</span><span class="o">.</span><span class="n">check4crossing_lines</span><span class="p">()</span>
        <span class="n">dg</span><span class="o">.</span><span class="n">check4zero_gradient</span><span class="p">()</span></div>

<div class="viewcode-block" id="LinesinkData.map_outsegs"><a class="viewcode-back" href="../../api/index.html#lsmaker.lsmaker.LinesinkData.map_outsegs">[docs]</a>    <span class="k">def</span> <span class="nf">map_outsegs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        from Mat2, returns dataframe of all downstream segments (will not work with circular routing!)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">outsegsmap</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">COMID</span><span class="p">)</span>
        <span class="n">outsegs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">dncomid</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">max_outseg</span> <span class="o">=</span> <span class="n">outsegsmap</span><span class="p">[</span><span class="n">outsegsmap</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">knt</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">while</span> <span class="n">max_outseg</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">outsegsmap</span><span class="p">[</span><span class="s1">&#39;outseg</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">knt</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="n">outsegs</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                                                  <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">outsegsmap</span><span class="p">[</span><span class="n">outsegsmap</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]]</span>
            <span class="n">max_outseg</span> <span class="o">=</span> <span class="n">outsegsmap</span><span class="p">[</span><span class="n">outsegsmap</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">max_outseg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">knt</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">knt</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Circular routing encountered in segment </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">max_outseg</span><span class="p">))</span>
                <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outsegs</span> <span class="o">=</span> <span class="n">outsegsmap</span></div>

<div class="viewcode-block" id="LinesinkData.read_lss"><a class="viewcode-back" href="../../api/index.html#lsmaker.lsmaker.LinesinkData.read_lss">[docs]</a>    <span class="k">def</span> <span class="nf">read_lss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lss_xml</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;read a linesink string (lss) XML file exported by GFLOW&quot;&quot;&quot;</span>
        <span class="n">xml</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">lss_xml</span><span class="p">)</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ComputationalUnits&#39;</span><span class="p">,</span> <span class="s1">&#39;BasemapUnits&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">attr</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span>

        <span class="c1"># read fields into dictionary, then DataFrame</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Label&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;HeadSpecified&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;StartingHead&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;EndingHead&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;Resistance&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;Width&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;Depth&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;Routing&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;EndStream&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;OverlandFlow&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;EndInflow&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;ScenResistance&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;Drain&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;ScenFluxName&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;Gallery&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;TotalDischarge&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;InletStream&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;OutletStream&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;OutletTable&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;Lake&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;Precipitation&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;Evapotranspiration&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;Farfield&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;chkScenario&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;AutoSWIZC&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;DefaultResistance&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtypes</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">==</span> <span class="nb">bool</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="n">field</span><span class="p">)],</span>
                                 <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">int_dtype</span><span class="p">)</span>
                    <span class="n">d</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">d</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">tf2flag</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">text</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="n">field</span><span class="p">)])</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="n">field</span><span class="p">)],</span>
                                <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtypes</span><span class="p">[</span><span class="n">field</span><span class="p">])</span>

        <span class="c1"># read in the vertices</span>
        <span class="k">def</span> <span class="nf">tolss</span><span class="p">(</span><span class="n">ls</span><span class="p">):</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ls</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;Vertices&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;Vertex&#39;</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ls</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;Vertices&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;Vertex&#39;</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">LineString</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">))</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">tolss</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span> <span class="k">for</span> <span class="n">ls</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s1">&#39;LinesinkString&#39;</span><span class="p">)]</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="c1"># convert labels back to COMIDs for the index; assign unique values otherwise</span>
        <span class="n">comids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">comids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">Label</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">comids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">comids</span>

        <span class="c1"># rename fields to be consistent with those used in Linesinkmaker</span>
        <span class="c1"># (should eventually just change lsmaker names to conform)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;DefaultResistance&#39;</span><span class="p">:</span> <span class="s1">&#39;resistance&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;Depth&#39;</span><span class="p">:</span> <span class="s1">&#39;depth&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;EndStream&#39;</span><span class="p">:</span> <span class="s1">&#39;end_stream&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;EndingHead&#39;</span><span class="p">:</span> <span class="s1">&#39;minElev&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;Farfield&#39;</span><span class="p">:</span> <span class="s1">&#39;farfield&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;Label&#39;</span><span class="p">:</span> <span class="s1">&#39;ls_name&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;Resistance&#39;</span><span class="p">:</span> <span class="s1">&#39;reistance&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;Routing&#39;</span><span class="p">:</span> <span class="s1">&#39;routing&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;StartingHead&#39;</span><span class="p">:</span> <span class="s1">&#39;maxElev&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;Width&#39;</span><span class="p">:</span> <span class="s1">&#39;width&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ls_coords&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">geometry</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="LinesinkData.write_lss_by_huc"><a class="viewcode-back" href="../../api/index.html#lsmaker.lsmaker.LinesinkData.write_lss_by_huc">[docs]</a>    <span class="k">def</span> <span class="nf">write_lss_by_huc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Grouping segments by hydrologic unit...&#39;</span><span class="p">)</span>
        <span class="c1"># intersect lines with HUCs; then group dataframe by HUCs</span>
        <span class="n">HUCs_df</span> <span class="o">=</span> <span class="n">gisutils</span><span class="o">.</span><span class="n">shp2df</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">HUC_shp</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">HUC_name_field</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">HUC_name_field</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">*</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">HUC</span> <span class="ow">in</span> <span class="n">HUCs_df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">HUCs_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">HUC</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]]</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">lines</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">HUC_name_field</span><span class="p">]</span> <span class="o">=</span> <span class="n">HUC</span>
        <span class="n">dfg</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">HUC_name_field</span><span class="p">)</span>

        <span class="c1"># write lines for each HUC to separate lss file</span>
        <span class="n">HUCs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">HUC</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">HUC</span> <span class="ow">in</span> <span class="n">HUCs</span><span class="p">:</span>
            <span class="n">dfh</span> <span class="o">=</span> <span class="n">dfg</span><span class="o">.</span><span class="n">get_group</span><span class="p">(</span><span class="n">HUC</span><span class="p">)</span>
            <span class="n">outfile</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">.lss.xml&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outfile_basename</span><span class="p">,</span> <span class="n">HUC</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_lss</span><span class="p">(</span><span class="n">dfh</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span></div>

<div class="viewcode-block" id="LinesinkData.write_lss"><a class="viewcode-back" href="../../api/index.html#lsmaker.lsmaker.LinesinkData.write_lss">[docs]</a>    <span class="k">def</span> <span class="nf">write_lss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">outfile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;write GFLOW linesink XML (lss) file from dataframe df</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;chkScenario&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">chkScenario</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)]</span>

        <span class="n">nlines</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">ls_coords</span><span class="p">])</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;writing </span><span class="si">{}</span><span class="s1"> lines to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nlines</span><span class="p">,</span> <span class="n">outfile</span><span class="p">))</span>
        <span class="n">ofp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;?xml version=&quot;1.0&quot;?&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;LinesinkStringFile version=&quot;1&quot;&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&lt;ComputationalUnits&gt;</span><span class="si">{}</span><span class="s1">&lt;/ComputationalUnits&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
                  <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&lt;BasemapUnits&gt;</span><span class="si">{}</span><span class="s1">&lt;/BasemapUnits&gt;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ComputationalUnits</span><span class="o">.</span><span class="n">capitalize</span><span class="p">(),</span>
                                                                 <span class="bp">self</span><span class="o">.</span><span class="n">BasemapUnits</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()))</span>

        <span class="k">for</span> <span class="n">comid</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&lt;LinesinkString&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;Label&gt;</span><span class="si">{}</span><span class="s1">&lt;/Label&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">comid</span><span class="p">,</span> <span class="s1">&#39;ls_name&#39;</span><span class="p">]))</span>
            <span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;HeadSpecified&gt;1&lt;/HeadSpecified&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;StartingHead&gt;</span><span class="si">{:.2f}</span><span class="s1">&lt;/StartingHead&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">comid</span><span class="p">,</span> <span class="s1">&#39;maxElev&#39;</span><span class="p">]))</span>
            <span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;EndingHead&gt;</span><span class="si">{:.2f}</span><span class="s1">&lt;/EndingHead&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">comid</span><span class="p">,</span> <span class="s1">&#39;minElev&#39;</span><span class="p">]))</span>
            <span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;Resistance&gt;</span><span class="si">{}</span><span class="s1">&lt;/Resistance&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">comid</span><span class="p">,</span> <span class="s1">&#39;resistance&#39;</span><span class="p">]))</span>
            <span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;Width&gt;</span><span class="si">{:.2f}</span><span class="s1">&lt;/Width&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">comid</span><span class="p">,</span> <span class="s1">&#39;width&#39;</span><span class="p">]))</span>
            <span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;Depth&gt;</span><span class="si">{:.2f}</span><span class="s1">&lt;/Depth&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">comid</span><span class="p">,</span> <span class="s1">&#39;depth&#39;</span><span class="p">]))</span>
            <span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;Routing&gt;</span><span class="si">{}</span><span class="s1">&lt;/Routing&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">comid</span><span class="p">,</span> <span class="s1">&#39;routing&#39;</span><span class="p">]))</span>
            <span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;EndStream&gt;</span><span class="si">{}</span><span class="s1">&lt;/EndStream&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">comid</span><span class="p">,</span> <span class="s1">&#39;end_stream&#39;</span><span class="p">]))</span>
            <span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;OverlandFlow&gt;0&lt;/OverlandFlow&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;EndInflow&gt;0&lt;/EndInflow&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;ScenResistance&gt;</span><span class="si">{}</span><span class="s1">&lt;/ScenResistance&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">comid</span><span class="p">,</span> <span class="s1">&#39;ScenResistance&#39;</span><span class="p">]))</span>
            <span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;Drain&gt;0&lt;/Drain&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;ScenFluxName&gt;__NONE__&lt;/ScenFluxName&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;Gallery&gt;0&lt;/Gallery&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;TotalDischarge&gt;0&lt;/TotalDischarge&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;InletStream&gt;0&lt;/InletStream&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;OutletStream&gt;0&lt;/OutletStream&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;OutletTable&gt;__NONE__&lt;/OutletTable&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;Lake&gt;0&lt;/Lake&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;Precipitation&gt;0&lt;/Precipitation&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;Evapotranspiration&gt;0&lt;/Evapotranspiration&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;Farfield&gt;</span><span class="si">{:.0f}</span><span class="s1">&lt;/Farfield&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">comid</span><span class="p">,</span> <span class="s1">&#39;farfield&#39;</span><span class="p">]))</span>
            <span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;chkScenario&gt;</span><span class="si">{}</span><span class="s1">&lt;/chkScenario&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">comid</span><span class="p">,</span> <span class="s1">&#39;chkScenario&#39;</span><span class="p">]))</span> <span class="c1"># include linesink in PEST &#39;scenarios&#39;</span>
            <span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;AutoSWIZC&gt;</span><span class="si">{:.0f}</span><span class="s1">&lt;/AutoSWIZC&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">comid</span><span class="p">,</span> <span class="s1">&#39;AutoSWIZC&#39;</span><span class="p">]))</span>
            <span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;DefaultResistance&gt;</span><span class="si">{:.2f}</span><span class="s1">&lt;/DefaultResistance&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">comid</span><span class="p">,</span> <span class="s1">&#39;resistance&#39;</span><span class="p">]))</span>
            <span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;Vertices&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># now write out linesink vertices</span>
            <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">comid</span><span class="p">,</span> <span class="s1">&#39;ls_coords&#39;</span><span class="p">]:</span>
                <span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">&lt;Vertex&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t\t\t</span><span class="s1">&lt;X&gt; </span><span class="si">{:.2f}</span><span class="s1">&lt;/X&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
                <span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t\t\t</span><span class="s1">&lt;Y&gt; </span><span class="si">{:.2f}</span><span class="s1">&lt;/Y&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
                <span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">&lt;/Vertex&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;/Vertices&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&lt;/LinesinkString&gt;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">ofp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;/LinesinkStringFile&gt;&#39;</span><span class="p">)</span>
        <span class="n">ofp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="LinesinkData.write_shapefile"><a class="viewcode-back" href="../../api/index.html#lsmaker.lsmaker.LinesinkData.write_shapefile">[docs]</a>    <span class="k">def</span> <span class="nf">write_shapefile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_ls_coords</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">outfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">outfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outfile_basename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.shp&#39;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">routid</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;dncomid&#39;</span><span class="p">,</span> <span class="s1">&#39;upcomids&#39;</span><span class="p">}</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)):</span>
            <span class="n">df</span><span class="p">[</span><span class="n">routid</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">routid</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]))</span>  <span class="c1"># handles empties</span>

        <span class="c1"># recreate shapely geometries from coordinates column; drop all other coords/geometries</span>
        <span class="k">if</span> <span class="n">use_ls_coords</span> <span class="ow">and</span> <span class="s1">&#39;ls_coords&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">LineString</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">ls_coords</span><span class="p">]</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;ls_coords&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">gisutils</span><span class="o">.</span><span class="n">df2shp</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">outfile</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="linesinks"><a class="viewcode-back" href="../../api/index.html#lsmaker.lsmaker.linesinks">[docs]</a><span class="k">class</span> <span class="nc">linesinks</span><span class="p">(</span><span class="n">LinesinkData</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;The &#39;linesinks&#39; class was renamed to LinesinkData to better follow pep 8.&quot;</span><span class="p">,</span>
                      <span class="ne">DeprecationWarning</span><span class="p">)</span>
        <span class="n">LinesinkData</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="InputFileMissing"><a class="viewcode-back" href="../../api/index.html#lsmaker.lsmaker.InputFileMissing">[docs]</a><span class="k">class</span> <span class="nc">InputFileMissing</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">infile</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">infile</span> <span class="o">=</span> <span class="n">infile</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Could not open or parse input file </span><span class="si">{0}</span><span class="s1">.</span><span class="se">\n</span><span class="s1">Check for errors in XML formatting.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">infile</span><span class="p">))</span></div>


<div class="viewcode-block" id="EmptyDataFrame"><a class="viewcode-back" href="../../api/index.html#lsmaker.lsmaker.EmptyDataFrame">[docs]</a><span class="k">class</span> <span class="nc">EmptyDataFrame</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Empty DataFrame!&#39;</span><span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
      <span class="lastupdated">
        Last updated on Jan 28, 2021.
      </span>

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>